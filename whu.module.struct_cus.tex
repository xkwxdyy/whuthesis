\WHUDependency{ disable={titlesec,titletoc,tocloft,etoc,placeins,multitoc,minitoc}, 
  module={util_cus} }
\WHUProvideExplModule{struct_cus}{\whu@d@te}{\whu@versi@n}{structures of document}

%SEE: ctexheading (ctexbook.cls), titlesec, titletoc, etoc, etc. 

\tl_new:N \g__whu_cbl_before_load_tl
\tl_new:N \g__whu_cbl_after_load_tl

\keys_define:nn { whu } { cbl-setup .meta:nn = { whu/cbl-setup } {#1} }
\keys_define:nn { whu/cbl-setup } 
  {
    from .tl_gset_e:N = \g__whu_cbl_file_tl ,
    from .initial:n = \c_sys_jobname_str ,
    write .bool_gset:N = \g__whu_cbl_write_bool ,
    write .initial:n = true ,
    to  .tl_gset_e:N = \g__whu_cbl_to_tl ,
    to    .initial:n = \exp_not:N \q_no_value ,
  }
\NewDocumentCommand \enablecombinedlist { !O{} }
  {
    \if_int_compare:w \g__whu_cbl_count_int < \c_zero_int
    \whu_if_preamble_test:TF { \whu_hook_gput_ds:n } { \use:n }
      { 
        \tl_if_blank:nF {#1} { \keys_set:nn { whu/cbl-setup } {#1} }
        \g__whu_cbl_before_load_tl
        \int_gzero:N \g__whu_cbl_count_int
        \@input { \g__whu_cbl_file_tl .toc } 
        \g__whu_cbl_after_load_tl
        \bool_if:NT \g__whu_cbl_write_bool 
          {
            \iow_new:N \tf@toc 
            \iow_open:Nn \tf@toc 
              { 
                \quark_if_no_value:NTF \g__whu_cbl_to_tl 
                  \c_sys_jobname_str \g__whu_cbl_to_tl .toc 
              }
          }
      }
    \fi:
  }
\int_new:N \g_whu_document_cbl_index_int 
\cs_new_protected:Npn \whu_gput_contents:nn #1#2
  {
    % 为了防止出现 \protect\addvspace{length} 的情况，目录项必须大于 3
    % 如 \protect\contentsline{type}{text}{page}{anchor}，至少有 6 项
    \if_int_compare:w \tl_count:n {#2} > 3 \exp_stop_f:
    \int_gincr:N \g_whu_document_cbl_index_int 
    \protected@write \@auxout
      {
        \cs_set_eq:NN \ifintitle \use_ii:nn
        \cs_set_eq:NN \ifincblentry \use_i:nn
        \cs_set_eq:NN \label \__whu_use_none_exp_om:w 
        \cs_set_eq:NN \index \__whu_use_none_exp_om:w 
        \cs_set_eq:NN \glossary \__whu_use_none_exp_om:w 
      }
      {
        \token_to_str:N \@writefile { toc } 
          { \__whu_gput_contents:nnn {#1} #2 }
      }
    \else:
      \protected@wlog { Abort~contents~entry:~`#2' }
    \fi:
  }
\cs_new:Npn \__whu_gput_contents:nnn #1#2#3
  { \token_if_eq_meaning:NNTF #2 \protect { #2#3{#1} } { #2{#1}{#3} } }
% 只保存数据，cbl结构为：\.{type}{type count}{info}{level}{entry}{page}{anchor}\@
% 只保存数据，type结构为：\.{type}{cbl count}{info}{level}{entry}{page}{anchor}\@
% type, level, data, page, anchor 
\cs_new_protected:Npn \whu_contents_line:nnnnn #1#2#3#4#5 
  {
    \int_gincr:N \g__whu_cbl_count_int
    \int_gincr:c { g__whu_cbl_type~#1_count_int }
    \clist_set:Nx \l__whu_tmpa_clist {#2}
    \tl_set:Nx \l__whu_cbl_heading_level_tl 
      { \exp_args:Ne \whu_heading_level:n { #1- \l__whu_tmpa_clist } }
    \tl_gset:cx 
      { whu/cbl~/cbl~ /entry [ \int_use:N \g__whu_cbl_count_int ] _tl }
      {
        \exp_not:N \whu@cbl@contentsline {#1} 
          { \int_use:c { g__whu_cbl_type~#1_count_int } }
          {#2} { \l__whu_cbl_heading_level_tl }
          { \exp_not:n {#3} } {#4} {#5} \exp_not:N \whu@cbl@contentsline@
      }
    \tl_gset:cx 
      { whu/cbl~/type~#1 /entry [ \int_use:c { g__whu_cbl_type~#1_count_int } ] _tl }
      {
        \exp_not:N \whu@type@contentsline {#1}
          { \int_use:N \g__whu_cbl_count_int }
          {#2} { \l__whu_cbl_heading_level_tl }
          { \exp_not:n {#3} } {#4} {#5} \exp_not:N \whu@type@contentsline@
      }
    \tl_gset:cx { whu/cbl~/type~#1 /lo_used_level_tl }
      { 
        \int_max:nn { \l__whu_cbl_heading_level_tl } 
          { \use:c { whu/cbl~/type~#1 /lo_used_level_tl } }
      }
    \tl_gset:cx { whu/cbl~/type~#1 /hi_used_level_tl }
      { 
        \int_min:nn { \l__whu_cbl_heading_level_tl } 
          { \use:c { whu/cbl~/type~#1 /hi_used_level_tl } }
      }
    \if_int_compare:w 
      \int_eval:w \whu_heading_level:n { #1-#2 } = \c_zero_int
      \clist_gput_right:cx { whu/cbl~/type~#1/default~level _count_clist }
        { \int_use:c { g__whu_cbl_type~#1_count_int } }
    \fi:
  }
\tl_put_right:Nn \g__whu_cbl_after_load_tl
  { % 在这些 clist 后添加一个额外的数字
    \seq_map_inline:Nn \g__whu_cbl_type_seq
      {
        \clist_gput_right:cx { whu/cbl~/type~#1/default~level _count_clist }
          { \int_eval:n { \int_use:c { g__whu_cbl_type~#1_count_int } + 1 } }
      }
  }
\cs_new_protected_nopar:Npn \whu_contents_get:nN #1#2 % cbl count, tl 
  { 
    \tl_if_exist:cTF { whu/cbl~/cbl~ /entry [ \int_eval:n {#1} ] _tl }
      { \tl_set_eq:Nc #2 { whu/cbl~/cbl~ /entry [ \int_eval:n {#1} ] _tl } }
      { \tl_set_eq:NN #2 \q_no_value }
  }
\cs_new_nopar:Npn \whu_contents_entry:n #1 % cbl count 
  { \exp_not:v { whu/cbl~/cbl~ /entry [ \int_eval:n {#1} ] _tl } }
\cs_new_protected_nopar:Npn \contents@entry #1
  { \cs:w whu/cbl~/cbl~ /entry [ \int_eval:n {#1} ] _tl \cs_end: }
\cs_new_nopar:Npn \whu_contents_entry_of:nn #1 % of, count 
  { \cs:w whu_contents_entry_of_ #1 :n \cs_end: }
\cs_new_nopar:Npn \whu_contents_entry_of_type:n #1
  { 
    \exp_last_unbraced:Ne 
      \whu_exp_not_use_ii:nnnnnnnnn { \whu_contents_entry:n {#1} } 
  }
\cs_new_nopar:Npn \whu_contents_entry_of_count:n #1
  { 
    \exp_last_unbraced:Ne 
      \whu_exp_not_use_iii:nnnnnnnnn { \whu_contents_entry:n {#1} } 
  }
\cs_new_nopar:Npn \whu_contents_entry_of_info:n #1
  { 
    \exp_last_unbraced:Ne 
      \whu_exp_not_use_iv:nnnnnnnnn { \whu_contents_entry:n {#1} } 
  }
\cs_new_nopar:Npn \whu_contents_entry_of_level:n #1
  { 
    \exp_last_unbraced:Ne 
      \whu_exp_not_use_v:nnnnnnnnn { \whu_contents_entry:n {#1} } 
  }
\cs_new_nopar:Npn \whu_contents_entry_of_entry:n #1
  { 
    \exp_last_unbraced:Ne 
      \whu_exp_not_use_vi:nnnnnnnnn { \whu_contents_entry:n {#1} } 
  }
\cs_new_nopar:Npn \whu_contents_entry_of_page:n #1
  { 
    \exp_last_unbraced:Ne 
      \whu_exp_not_use_vii:nnnnnnnnn { \whu_contents_entry:n {#1} } 
  }
\cs_new_nopar:Npn \whu_contents_entry_of_anchor:n #1
  { 
    \exp_last_unbraced:Ne 
      \whu_exp_not_use_viii:nnnnnnnnn { \whu_contents_entry:n {#1} } 
  }
\cs_new_protected_nopar:Npn \whu_contents_type_get:nnN #1#2#3 % type, type count, tl 
  { 
    \tl_if_exist:cTF { whu/cbl~/type~#1 /entry [ \int_eval:n {#2} ] _tl }
      { \tl_set_eq:Nc #3 { whu/cbl~/type~#1 /entry [ \int_eval:n {#2} ] _tl } }
      { \tl_set_eq:NN #3 \q_no_value }
  }
\cs_new_nopar:Npn \whu_contents_type_entry:nn #1#2 % type, type count 
  { \exp_not:v { whu/cbl~/type~#1 /entry [ \int_eval:n {#2} ] _tl } }
\cs_new_protected_nopar:Npn \contents@typeentry #1#2
  { \cs:w whu/cbl~/type~#1 /entry [ \int_eval:n {#2} ] _tl \cs_end: }
\cs_new_nopar:Npn \whu_contents_type_entry_of:nnn #1#2 % type, of, count 
  { \cs:w whu_contents_type_entry_of_ #2 :nn \cs_end: {#1} }
\cs_new_nopar:Npn \whu_contents_type_entry_of_type:nn #1#2
  { 
    \exp_last_unbraced:Ne 
      \whu_exp_not_use_ii:nnnnnnnnn { \whu_contents_type_entry:nn {#1} {#2} } 
  }
\cs_new_nopar:Npn \whu_contents_type_entry_of_count:nn #1#2
  { 
    \exp_last_unbraced:Ne 
      \whu_exp_not_use_iii:nnnnnnnnn { \whu_contents_type_entry:nn {#1} {#2} } 
  }
\cs_new_nopar:Npn \whu_contents_type_entry_of_info:nn #1#2
  { 
    \exp_last_unbraced:Ne 
      \whu_exp_not_use_iv:nnnnnnnnn { \whu_contents_type_entry:nn {#1} {#2} } 
  }
\cs_new_nopar:Npn \whu_contents_type_entry_of_level:nn #1#2
  { 
    \exp_last_unbraced:Ne 
      \whu_exp_not_use_v:nnnnnnnnn { \whu_contents_type_entry:nn {#1} {#2} } 
  }
\cs_new_nopar:Npn \whu_contents_type_entry_of_entry:nn #1#2
  { 
    \exp_last_unbraced:Ne 
      \whu_exp_not_use_vi:nnnnnnnnn { \whu_contents_type_entry:nn {#1} {#2} } 
  }
\cs_new_nopar:Npn \whu_contents_type_entry_of_page:nn #1#2
  { 
    \exp_last_unbraced:Ne 
      \whu_exp_not_use_vii:nnnnnnnnn { \whu_contents_type_entry:nn {#1} {#2} } 
  }
\cs_new_nopar:Npn \whu_contents_type_entry_of_anchor:nn #1#2
  { 
    \exp_last_unbraced:Ne 
      \whu_exp_not_use_viii:nnnnnnnnn { \whu_contents_type_entry:nn {#1} {#2} } 
  }
\cs_new_protected:Npn \__whu_contentsline_push_def:nn #1#2
  {
    \int_gincr:N \g__whu_map_int
    \cs_gset_eq:cN 
      { __whu_iterate_contents_ \int_use:N \g__whu_map_int :w }
    \cs_gset_eq:cN 
      { __whu_iterate_contents@_ \int_use:N \g__whu_map_int :w }
      \whu@cbl@contentsline@
      \whu@cbl@contentsline
    \cs_set:Npn \whu@cbl@contentsline ##1##2##3##4##5##6##7 {#1}
    \cs_set:Npn \whu@cbl@contentsline@ {#2}
  }
\cs_new_protected:Npn \__whu_contentsline_pop_def:
  {
    \cs_set_eq:Nc \whu@cbl@contentsline
      { __whu_iterate_contents_ \int_use:N \g__whu_map_int :w }
    \cs_set_eq:Nc \whu@cbl@contentsline@
      { __whu_iterate_contents@_ \int_use:N \g__whu_map_int :w }
    \int_gdecr:N \g__whu_map_int
  }
\cs_new_protected:Npn \whu_map_contents_inline:n #1
  {
    \__whu_contentsline_push_def:nn {#1} { }
    \int_step_inline:nn { \g__whu_cbl_count_int }
      { \cs:w whu/cbl~/cbl~ /entry [##1] _tl \cs_end: }
    \__whu_contentsline_pop_def:
  }
\cs_new_protected:Npn \whu_map_contents_type_inline:nn #1#2 % type, code 
  {
    \__whu_contentsline_push_def:nn {#2} { }
    \int_step_inline:nn { \int_use:c { g__whu_cbl_type~#1_count_int } }
      { \cs:w whu/cbl~/type~#1 /entry [##1] _tl \cs_end: }
    \__whu_contentsline_pop_def:
  }
\cs_new_protected:Npn \__whu_contents_line:nnnnnnn #1#2#3#4#5#6#7
  {
    \whu_use_psr:n { toc / #1 } {#1}{#2}{#3}{#4}{#5}{#6}{#7}
  }
\cs_new_protected:Npn \whu_cbl_fliter:nnnnnnnnn #1#2#3#4#5#6#7 % ,,,,,true,false 
  { \use_i:nn }
\cs_new_protected_nopar:Npn \flitercombinedlistentry { \whu_cbl_fliter:nnnnnnnnn }
\cs_new_protected:Npn \whu_set_filter:n #1 % must end with \if...
  {
    \cs_set_protected:Npn \whu_cbl_fliter:nnnnnnnnn ##1##2##3##4##5##6##7
      {
        #1
          \exp_after:wN \use_i:nn
        \else:
          \exp_after:wN \use_ii:nn
        \fi:
      }
  }
\cs_new_eq:NN \setcombinedlistfilter \whu_set_filter:n 

\cs_new_nopar:Npn \whu_heading_level:n #1
  {
    \whu_if_head_int:nTF {#1}
      { \int_value:w #1 }
      { \__whu_heading_level:w #1 , \s_stop }
  }
\cs_new_nopar:Npn \whu_heading_level:nn #1#2
  { \int_eval:n { \prop_item:Ne \g__whu_heading_level_prop { #1-#2 } + 0 } }
\cs_new_protected_nopar:Npn \whu_get_heading_level:nnN #1#2
  { \exp_args:NNe \prop_get:NnN \g__whu_heading_level_prop { #1-#2 } }
\cs_new:Npn \__whu_heading_level:w #1-#2, #3 \s_stop 
  { 
    \whu_if_head_int:nTF {#2} 
      { \int_eval:w #2 }
      {
        \int_value:w \int_eval:w \prop_item:Ne \g__whu_heading_level_prop
          { #1-\if:w \scan_stop: #2 \scan_stop: main \else: #2 \fi: } + 0 \scan_stop:
      }
  }
\cs_new_protected_nopar:Npn \whu_gset_heading_level:nnn #1#2#3 % type, heading, level 
  {
    \int_gset:Nn \max@headinglevel { \int_min:nn \max@headinglevel { #3 + 0 } }
    \int_gset:Nn \min@headinglevel { \int_max:nn \min@headinglevel { #3 + 0 } }
    \prop_gput:Nxx \g__whu_heading_level_prop { #1-#2 } 
      { \int_eval:n { #3 + 0 } }
  }
\cs_new_protected_nopar:Npn \whu_cbl_add:nn #1#2 % type , key-val 
  {
    \if_int_compare:w \g__whu_cbl_count_int < \c_one_int
    \int_if_exist:cF { g__whu_cbl_type~#1_count_int }
      { 
        \int_new:c { g__whu_cbl_type~#1_count_int }
        \cs_set_eq:cc { total@type#1@count } { g__whu_cbl_type~#1_count_int }
        \clist_new:c { whu/cbl~/type~#1 /default~level _count_clist }
        \tl_gset:cx { whu/cbl~/type~#1 /hi_used_level_tl } { \int_use:N \c_max_int }
        \tl_gset:cx { whu/cbl~/type~#1 /lo_used_level_tl } { -\int_use:N \c_max_int }
        \seq_put_right:Nx \g__whu_cbl_type_seq {#1}
      }
    \keyval_parse:nnn 
      { \__whu_cbl_add_aux:nn {#1} }
      { \whu_gset_heading_level:nnn {#1} }
      { main, #2 }
    \else:
      \msg_warning:nnn { whu } { struct-unused-cbl } {#1}
    \fi:
  }
\cs_new:Npn \__whu_cbl_add_aux:nn #1#2
  {
    \use:e 
      {
        \whu_gset_heading_level:nnn {#1} 
        \whu_exp_args:Nd \elkernel_exp_not:w { \exp_after:wN \whu_unbracket:nw \elkernel_exp:w { \whu_split_bracket_tail:n {#2} } }
      }
  }
\cs_new_eq:NN \addcombinedlisttype \whu_cbl_add:nn 
\cs_new_nopar:Npn \retcbltypelevel #1#2 { \whu_heading_level:n { #1 - #2 } }
\cs_new:Npn \whu_cbl_get_total_count:n #1
  {
    \tl_if_empty:nTF {#1} { \int_use:N \g__whu_cbl_count_int }
      {
        \int_if_exist:cTF { g__whu_cbl_type~#1_count_int }
          { \int_use:c { g__whu_cbl_type~#1_count_int } }
          { 
            \msg_expandable_error:nnn { whu } { struct-cbl-unknown } {#1}
            \int_value:w \c_zero_int
          }
      }
  }
\cs_new_nopar:Npn \retcbltotalcounts #1 
  { \exp_args:Ne \whu_cbl_get_total_count:n { \tl_trim_spaces:n {#1} } }
\cs_new_nopar:Npn \retcblentryname #1#2
  {
    \tl_if_blank:nTF {#1} 
      { whu/cbl~/cbl~/entry[\int_eval:n{#2}] _tl }
      { whu/cbl~/type~\tl_trim_spaces:n {#1}/entry[\int_eval:n{#2}] _tl }
  }
\cs_new_nopar:Npn \retcbldefaultlevellistname #1
  { whu/cbl~/type~ \tl_trim_spaces:n {#1} /default~level _count_clist }
\cs_new_nopar:Npn \retcblentrydata #1#2
  {
    \tl_if_blank:nTF {#1}
      { \whu_contents_entry_of:nn { \tl_trim_spaces:n {#2} } }
      { \whu_contents_type_entry_of:nnn { \tl_trim_spaces:n {#1} } { \tl_trim_spaces:n {#2} } }
  }
\cs_new_protected_nopar:Npn \iteratecontents #1#2
  {
    \tl_if_blank:nTF {#1}
      { \whu_map_contents_inline:n }
      { \whu_map_contents_type_inline:nn { \tl_trim_spaces:n {#1} } }
  }

\prop_new:N \g__whu_heading_level_prop
\seq_new:N \g__whu_cbl_type_seq 
\int_new:N \g__whu_cbl_count_int
\cs_set_eq:NN \total@cbl@count \g__whu_cbl_count_int
\int_new:N \max@headinglevel % 
\int_new:N \min@headinglevel % min@headinglevel >= max@headinglevel
\int_set:Nn \g__whu_cbl_count_int { -1 }
\whu_new_psr:nnn { toc } { 7 } { }
\whu_new_psr:nnn { toc-level~-1 } { 7 } { }
\whu_new_psr:nnn { toc-level~0 } { 7 } { }
\whu_new_psr:nnn { toc-level~1 } { 7 } { }
\whu_new_psr:nnn { toc-level~2 } { 7 } { }
\whu_new_psr:nnn { toc-level~3 } { 7 } { }
\whu_new_psr:nnn { toc-level~4 } { 7 } { }
\whu_new_psr:nnn { toc-level~5 } { 7 } { }
\whu_new_psrrule:nnn { toc } { level-uniform }
  { \whu_use_psr:n { toc-level~#4 } {#1}{#2}{#3}{#4}{#5}{#6}{#7} }
\whu_new_psrrule:nnn { toc } { level-uniform-hyper }
  {
    \str_set:Nx \Hy@tocdestname {#7}
    \if:w \scan_stop: \Hy@tocdestname \scan_stop:
      \whu_use_psr:n { toc-level~#4 } {#1}{#2}{#3}{#4}{#5}{#6}{#7}
    \else:
      \if_case:w \Hy@linktoc % none 
        \whu_use_psr:n { toc-level~#4 } {#1}{#2}{#3}{#4}{#5}{#6}{#7}
      \or: % section 
        \whu_use_psr:n { toc-level~#4 } {#1}{#2}{#3}{#4}{\whu@colorlink\hyper@link{toc}{#7}{#5}}{#6}{#7}
      \or: % page 
        \tl_if_empty:nTF {#6}
          { \whu_use_psr:n { toc-level~#4 } {#1}{#2}{#3}{#4}{#5}{#6}{#7} }
          { \whu_use_psr:n { toc-level~#4 } {#1}{#2}{#3}{#4}{#5}{\whu@colorlink\hyper@link{toc}{#7}{#6}}{#7} }
      \or:
        \tl_if_empty:nTF {#6}
          { \whu_use_psr:n { toc-level~#4 } {#1}{#2}{#3}{#4}{\whu@colorlink\hyper@link{toc}{#7}{#5}}{#6}{#7} }
          { \whu_use_psr:n { toc-level~#4 } {#1}{#2}{#3}{#4}{\whu@colorlink\hyper@link{toc}{#7}{#5}}{\whu@colorlink\hyper@link{toc}{#7}{#6}}{#7} }
      \fi:
    \fi:
  }
\tl_put_right:Nn \g__whu_cbl_before_load_tl
  {
    \seq_map_inline:Nn \g__whu_cbl_type_seq
      {
        \whu_psr_if_exist:nF { toc/#1 }
          {
            \whu_new_psr:nnn { toc/#1 } { 7 }
              { \whu_use_psr:n { toc } {##1}{##2}{##3}{##4}{##5}{##6}{##7} }
          }
      }
  }

\whu_cbl_add:nn { toc } 
  { 
    part[-1], 
    chapter[0], 
    section[1], subsection[2], subsubsection[3], 
    sub3section[4], sub4section[5], 
    paragraph[4], subparagraph[5], 
  }
\whu_cbl_add:nn { lof } { figure=1 }
\whu_cbl_add:nn { lot } { table=1 }
\whu_pkg_code:nnn { algorithm2e } { } { \whu_cbl_add:nn { loa } { algocf=1 } }
\whu_pkg_code:nnn { chemmacros } { } { \whu_cbl_add:nn { lor } { reaction=1 } }
\whu_pkg_code:nnn { hypdvips } { } { \whu_cbl_add:nn { loa } { FileAttachment=1, EmbeddedFile=1 } }
\whu_pkg_code:nnn { musical } { } 
  {
    \whu_cbl_add:nn { los } { section=1 }
    \whu_cbl_add:nn { lod } { section=1 }
  }
\whu_pkg_code:nnn { listings } { } { \whu_cbl_add:nn { lol } { lol=1, lstlisting=1 } }
\whu_pkg_code:nnn { pdfcomment } { } { \whu_cbl_add:nn { lpc } { lpcsec=1 } }
\whu_pkg_code:nnn { poetry } { } { \whu_cbl_add:nn { lop } { poem=1, poemgroup=1 } }
\whu_pkg_code:nnn { todonotes } { } { \whu_cbl_add:nn { tdo } { todo=1 } }
\char_set_catcode_other:N \#
\whu_pkg_code:nnn { float } { }
  {
    \ctex_patch_cmd:Nnn \newfloat { \floatplacement }
      { \addcombinedlisttype{#3}{#1=1}\floatplacement }
  }
\whu_pkg_code:nnn { newfloat } { }
  {
    \ctex_patch_cmd:Nnn \@DeclareFloatingEnvironment 
      { \newfloat@setoptions*{#2}{#1} }
      { \newfloat@setoptions*{#2}{#1}\addcombinedlisttype{\@nameuse{ext@#2}}{#2=1} }
  }
\char_set_catcode_parameter:N \#
\whu_pkg_code:nnn { floatrow } { }
  {
    \ctex_appto_cmd:NnnTF \DeclareNewFloatType { \ExplSyntaxOff \makeatletter }
      { \addcombinedlisttype{\@nameuse{ext@\FB@captype}}{\FB@captype=1} } { }
      { \whu_patch_failure:N \DeclareNewFloatType }
  }
\whu_pkg_code:nnn { tcolorbox } { }
  {
    \ctex_patch_cmd:Nnn \tcb@proc@options@init
      { \ifx\kvtcb@new@listof\@empty\else }
      { \ifx\kvtcb@new@listof\@empty\else
        \addcombinedlisttype{\kvtcb@new@listof}{\kvtcb@new@listtype=1} }
  }
\whu_pkg_code:nnn { thmtools } { }
  {
    \addcombinedlisttype{loe}{}
    \@ifpackageloaded{amsthm}
      {
        \use:e { \ctex_patch_cmd:Nnn \exp_not:N \@xnthm { \global } 
          { \addcombinedlisttype { \c_hash_str 2 = 1 } \global } }
      } { }
    \def\thmt@mklistcmd{
      \thmtlo@newentry 
      \ifthmt@isstarred 
        \@xa\def\csname ll@\thmt@envname\endcsname{
          \protect\numberline{\relax\protect\let\protect\autodot\protect\@empty}{\thmt@thmname}
          \ifx\@empty\thmt@shortoptarg\else\protect\thmtformatoptarg{\thmt@shortoptarg}\fi}
      \else 
        \@xa\def\csname ll@\thmt@envname\endcsname{
          \protect\numberline{\ignorespaces\csname the\thmt@envname\endcsname}
          {\thmt@thmname}
          \ifx\@empty\thmt@shortoptarg\else\protect\thmtformatoptarg{\thmt@shortoptarg}\fi}
      \@xa\gdef\csname thmt@contentsline@\thmt@envname\endcsname{\thmt@contentslineShow}}
    \renewcommand\listoftheorems[1][]{
      \begingroup \setlisttheoremstyle{#1}
      \let\whu@type@contentsline@\@empty 
      \let\thmt@numberline\numberline 
      \def\whu@type@contentsline##1##2##3##4{
        \exp_args:Ncf\empty{thmt@contentsline@ \whu_clist_item_first:n{##3}}
          {\whu_clist_item_first:n{##3}}}
      \ifthmt@listswap
        \def\numberline##1##2
          {\tl_if_head_eq_meaning:nNTF{##1}\relax{##2}
            {\thmt@numberline{##2\nobreakspace}##1}}
      \else \def\numberline{\thmt@numberline}
      \fi 
      \exp_last_unbraced:NNo \@for\thmt@envname {\string :=}\thmt@allenvs\do{\thmtlo@newentry}
      \multicolplaincombinedlist[1]{\listtheoremname}{loe}
      \endgroup}
    \AtBeginDocument{\def\thmt@contentsline#1#2#3#4
      {\whu_use_psr:n{toc/loe}{loe}{0}{#1}{1}{#2}{#3}{#4}}}
  }

\cs_new_protected_nopar:Npn \whu@cbl@contentsline@ { }
\cs_new_protected_nopar:Npn \whu@type@contentsline@ { }
\cs_new_protected_nopar:Npn \whu@cbl@contentsline { \__whu_contents_line:nnnnnnn }
\cs_new_protected_nopar:Npn \whu@type@contentsline { \__whu_contents_line:nnnnnnn }
\whu_pkg_code:nnn { hyperref }
  {
    \cs_set_eq:NN \addtocontents \whu_gput_contents:nn 
    \cs_set_eq:NN \contentsline \whu_contents_line:nnnnn 
    \whu_gbey_psrrule:nn { toc } { level-uniform }
  }
  {
    \cs_set_eq:NN \addtocontents \whu_gput_contents:nn 
    \cs_set_eq:NN \contentsline \whu_contents_line:nnnnn 
    \hook_new:n { hyp/link/toc }
    \whu_gbey_psrrule:nn { toc } { level-uniform-hyper }
  }

\if_predicate:w \cs_if_exist_p:N \CTEXnumberline 
\cs_set_eq:NN \CTEX@addloflotskip \use_none:n

\fi:

\msg_new:nnnn { whu } { struct-unused-cbl }
  { The~combinedlist~entry~`#1'~will~never~be~used. }
  { You~must~add~it~before~`\enablecombinedlist'. }
\msg_new:nnn { whu } { struct-cbl-unknown }
  { The~combinedlist~type~`#1'~is~unknown. }

\cs_set_protected:Npn \numberline #1
  {
    \hbox_set:Nn \l__whu_tmpa_box {#1}
    \dim_set:Nn \@tempdima
      {
        \dim_max:nn { \@tempdima }
          { \box_wd:N \l__whu_tmpa_box + \f@size \p@ / 2 }
      }
    \hbox_to_wd:nn \@tempdima { \hbox_unpack_drop:N \l__whu_tmpa_box \tex_hfil:D }
  }


\cs_new_protected:Npn \whu_specified_cbl_style:nnnnnnn #1#2#3#4#5#6#7
% type, level, list start, block start, block entry, block finish, list finish
  {
    \tl_set:cn { @toc@#1@#2@liststart } {#3}
    \tl_set:cn { @toc@#1@#2@blockstart } {#4}
    \tl_set:cn { @toc@#1@#2@blockitem } {#5}
    \tl_set:cn { @toc@#1@#2@blockfinish } {#6}
    \tl_set:cn { @toc@#1@#2@listfinish } {#7}
  }
\cs_new_protected:Npn \whu_specified_cbl_style_save:nnnnnnnN #1#2#3#4#5#6#7#8
% type, level, list start, block start, block entry, block finish, list finish, tl
  {
    % 必须先自行初始化
    \tl_build_put_right:Nx #8
      {
        \tl_set:Nn \exp_not:c { @toc@#1@#2@liststart } { \exp_not:n {#3} }
        \tl_set:Nn \exp_not:c { @toc@#1@#2@blockstart } { \exp_not:n {#4} }
        \tl_set:Nn \exp_not:c { @toc@#1@#2@blockitem } { \exp_not:n {#5} }
        \tl_set:Nn \exp_not:c { @toc@#1@#2@blockfinish } { \exp_not:n {#6} }
        \tl_set:Nn \exp_not:c { @toc@#1@#2@listfinish } { \exp_not:n {#7} }
      }
  }
\cs_new_protected:Npn \whu_specified_cbl:n #1
  {
    \group_begin:
    \tl_if_empty:nTF {#1}
      { 
        \tl_set:Nx \toclolevel { -\int_use:N \c_max_int }
        \tl_set:Nx \tochilevel { \int_use:N \c_max_int }
        \seq_map_inline:Nn \g__whu_cbl_type_seq
          {
            \tl_set:Nx \toclolevel 
              { \int_max:nn { \toclolevel } { \use:c { whu/cbl~/type~##1 /lo_used_level_tl } } }
            \tl_set:Nx \tochilevel 
              { \int_min:nn { \tochilevel } { \use:c { whu/cbl~/type~##1 /hi_used_level_tl } } }
          }
        \cs_set:Npn \__whu_specified_cbl_set_next_entry:
          { \whu_contents_get:nN { \toctheindex+1 } \tocthenextentry }
        \cs_set:Npn \__whu_specified_cbl_set_prev_entry:
          { \whu_contents_get:nN { \toctheindex-1 } \tocthepreventry }
      }
      {
        \tl_set:Nx \toclolevel { \use:c { whu/cbl~/type~#1 /lo_used_level_tl } }
        \tl_set:Nx \tochilevel { \use:c { whu/cbl~/type~#1 /hi_used_level_tl } }
        \cs_set:Npn \__whu_specified_cbl_set_next_entry:
          { \whu_contents_type_get:nnN {#1} { \toctheindex+1 } \tocthenextentry }
        \cs_set:Npn \__whu_specified_cbl_set_prev_entry:
          { \whu_contents_type_get:nnN {#1} { \toctheindex-1 } \tocthepreventry }
      }
    \whu@toc@contentsline@begin 
    \cs_set:Npn \whu@toc@contentsline ##1##2##3##4##5##6##7##8##9
      {
        \tl_gset:Nn \tocthetype {##1}
        \tl_gset:Nn \tocthecount {##2}
        \tl_gset:Nn \toctheindex {##9}
        \__whu_specified_cbl_info:w ##3, \s__whu_mark 
        \tl_gset:Nn \tocthelevel {##4}
        \__whu_specified_cbl_set_prev_entry:
        \tl_gset_eq:NN \tocthepreventry \tocthepreventry 
        \quark_if_no_value:NTF \tocthepreventry 
          { 
            \tl_gset:Nx \toctheprevlevel { - \int_use:N \c_max_int } 
            \cs_gset_eq:NN \tocifheadentry \use_i:nn
          }
          { 
            \tl_gset:Nx \toctheprevlevel { \tl_item:Nn \tocthepreventry { 5 } } 
            \cs_gset_eq:NN \tocifheadentry \use_ii:nn
          }
        \__whu_specified_cbl_set_next_entry:
        \tl_gset_eq:NN \tocthenextentry \tocthenextentry 
        \quark_if_no_value:NTF \tocthenextentry 
          { 
            \tl_gset:Nx \tocthenextlevel { - \int_use:N \c_max_int } 
            \cs_gset_eq:NN \tociftailentry \use_i:nn
          }
          { 
            \tl_gset:Nx \tocthenextlevel { \tl_item:Nn \tocthenextentry { 5 } } 
            \cs_gset_eq:NN \tociftailentry \use_ii:nn
          }
        \tl_if_head_eq_meaning:nNTF {##5} \numberline 
        % \exp_args:Nne \tl_if_in:nnTF 
        %   { \numberline\chapternumberline\partnumberline\booknumberline }
        %   { \tl_head:n {##5} }
          { \__whu_specified_cbl_split:nnw ##5 \s__whu_mark }
          { \__whu_specified_cbl_split:nnw {} {} ##5 \s__whu_mark }
        \tl_gset:Nn \tocthepage {##6}
        \__whu_if_head_int_dec:nTF { \tocthepage }
          { \cs_gset_eq:NN \tocifpageisnumber \use_i:nn }
          { \cs_gset_eq:NN \tocifpageisnumber \use_ii:nn }
        \tl_gset:Nn \toctheanchor {##7}
        \__whu_specified_cbl_code: 
      }
    \cs_set_eq:NN \tocifheadentry \use_i:nn
    \cs_set_eq:NN \tociftailentry \use_ii:nn
    \cs_set_protected:Npn \toclink { \whu_ref_target:nn \toctheanchor }
    \cs_set_protected:Npn \toclinkbox { \whu_ref_target_box:nn \toctheanchor }
    \cs_set:Npn \whu@cbl@contentsline  { \whu@toc@contentsline }
    \cs_set:Npn \whu@type@contentsline { \whu@toc@contentsline }
    \int_step_inline:nn 
      {
        \tl_if_empty:nTF {#1} { \g__whu_cbl_count_int }
          { \int_use:c { g__whu_cbl_type~#1_count_int } }
      }
      { \cs:w whu/cbl~ \tl_if_empty:nTF {#1} { /cbl~ } { /type~#1 } /entry [##1] _tl \cs_end: {##1} }
    \whu@toc@contentsline@end 
    \group_end:
  }
\cs_new_protected:Npn \whu_specified_cbl:nnn #1#2#3 % toc type, level, curr count
  {
    \group_begin:
    \__whu_specified_cbl_set_special_cs:n {#1}
    \bool_lazy_or:nnTF
      { \tl_if_empty_p:n {#3} }
      { \tl_if_novalue_p:n {#3} }
      { 
        \int_compare:nNnTF { \$ } > { 0 }
          {
            \tl_if_novalue:nTF {#2}
              { \__whu_specified_cbl_local:nnn {#1} {  } { \$ } }
              { \__whu_specified_cbl_local:nnn {#1} {#2} { \$ } }
          }
          { \whu_specified_cbl:n {#1} }
      }
      {
        \int_compare:nNnTF {#3} > { 0 }
          {
            \tl_if_novalue:nTF {#2}
              { \__whu_specified_cbl_local:nnn {#1} {  } {#3} }
              { \__whu_specified_cbl_local:nnn {#1} {#2} {#3} }
          }
          { \whu_specified_cbl:n {#1} }
      }
    \group_end:
  }
\cs_new_protected:Npn \__whu_specified_cbl_local:nnn #1#2#3
  {
    \use:e { \__whu_specified_cbl_local_aux:nnn {#1} {#2} } {#3}
  }
\cs_new_protected:Npn \__whu_specified_cbl_local_aux:nnn #1#2#3
  {
    \tl_if_empty:nTF {#1}
      { 
        \tl_set:Nx \tochilevel { \int_use:N \c_max_int }
        \seq_map_inline:Nn \g__whu_cbl_type_seq
          {
            \tl_set:Nx \tochilevel 
              { \int_min:nn { \tochilevel } { \use:c { whu/cbl~/type~##1 /hi_used_level_tl } } }
          }
        \cs_set:Npn \__whu_specified_cbl_set_next_entry:
          { \whu_contents_get:nN { \toctheindex+1 } \tocthenextentry }
        \cs_set:Npn \__whu_specified_cbl_set_prev_entry:
          { \whu_contents_get:nN { \toctheindex-1 } \tocthepreventry }
      }
      {
        \tl_set:Nx \tochilevel { \use:c { whu/cbl~/type~#1 /hi_used_level_tl } }
        \cs_set:Npn \__whu_specified_cbl_set_next_entry:
          { \whu_contents_type_get:nnN {#1} { \toctheindex+1 } \tocthenextentry }
        \cs_set:Npn \__whu_specified_cbl_set_prev_entry:
          { \whu_contents_type_get:nnN {#1} { \toctheindex-1 } \tocthepreventry }
      }
    \whu_if_head_int:nTF {#2}
      { 
        \int_compare:nNnTF { \tochilevel } > {#2} 
          { \whu_specified_cbl:n {#1} } 
          { 
            \tl_set:Nx \tochilevel { \int_eval:n {#2} }
            \exp_args:Nnf \__whu_specified_cbl_local_real:nnn {#1} { \int_eval:n {#2} } {#3} 
          } 
      }
      { 
        \int_compare:nNnTF { \tochilevel } >
          { \tl_if_empty:nTF {#1} { 0 } { \whu_heading_level:nn {#1} {#2} } }
          { \whu_specified_cbl:n {#1} } 
          {
            \tl_set:Nx \tochilevel 
              { \tl_if_empty:nTF {#1} { 0 } { \whu_heading_level:nn {#1} {#2} } }
            \__whu_specified_cbl_local_real:nnn {#1} {#2} {#3} 
          } 
      }
  }
\cs_new_protected:Npn \__whu_specified_cbl_local_real:nnn #1#2#3
  {
    \tl_set:Nx \toclolevel { -\int_use:N \c_max_int }
    \int_zero:N \l__whu_cbl_search_min_int
    \int_zero:N \l__whu_cbl_search_max_int
    \tl_if_empty:nTF {#1} 
      { 
        \exp_args:Nf \__whu_specified_cbl_search:n 
          { \int_max:nn { 0 } { \int_min:nn { #3 } { \g__whu_cbl_count_int } } }
      }
      { 
        \exp_args:Nnnf \__whu_specified_cbl_search:nnn {#1} {#2}
          {
            \int_max:nn { 0 }
              {
                \int_min:nn { #3 } { \use:c { g__whu_cbl_type~#1_count_int } }
              }
          }
      }
    \whu@toc@contentsline@begin 
    \cs_set:Npn \whu@toc@contentsline ##1##2##3##4##5##6##7##8##9
      {
        \tl_gset:Nn \tocthetype {##1}
        \tl_gset:Nn \tocthecount {##2}
        \tl_gset:Nn \toctheindex {##9}
        \__whu_specified_cbl_info:w ##3, \s__whu_mark 
        \tl_gset:Nn \tocthelevel {##4}
        \__whu_specified_cbl_set_prev_entry:
        \tl_gset_eq:NN \tocthepreventry \tocthepreventry 
        \quark_if_no_value:NTF \tocthepreventry 
          { 
            \tl_gset:Nx \toctheprevlevel { - \int_use:N \c_max_int } 
            \cs_gset_eq:NN \tocifheadentry \use_i:nn
          }
          { 
            \int_compare:nNnTF \toctheindex > \l__whu_cbl_search_min_int
              {
                \tl_gset:Nx \toctheprevlevel { \tl_item:Nn \tocthepreventry { 5 } } 
                \cs_gset_eq:NN \tocifheadentry \use_ii:nn
              }
              {
                \cs_gset_eq:NN \tocthepreventry \q_no_value
                \tl_gset:Nx \toctheprevlevel { - \int_use:N \c_max_int } 
                \cs_gset_eq:NN \tocifheadentry \use_i:nn
              }
          }
        \__whu_specified_cbl_set_next_entry:
        \tl_gset_eq:NN \tocthenextentry \tocthenextentry 
        \quark_if_no_value:NTF \tocthenextentry 
          { 
            \tl_gset:Nx \tocthenextlevel { - \int_use:N \c_max_int } 
            \cs_gset_eq:NN \tociftailentry \use_i:nn
          }
          { 
            \int_compare:nNnTF \toctheindex < \l__whu_cbl_search_max_int
              {
                \tl_gset:Nx \tocthenextlevel { \tl_item:Nn \tocthenextentry { 5 } } 
                \cs_gset_eq:NN \tociftailentry \use_ii:nn
              }
              {
                \cs_gset_eq:NN \tocthenextentry \q_no_value
                \tl_gset:Nx \tocthenextlevel { - \int_use:N \c_max_int } 
                \cs_gset_eq:NN \tociftailentry \use_i:nn
              }
          }
        \tl_if_head_eq_meaning:nNTF {##5} \numberline 
        % \exp_args:Nne \tl_if_in:nnTF 
        %   { \numberline\chapternumberline\partnumberline\booknumberline }
        %   { \tl_head:n {##5} }
          { \__whu_specified_cbl_split:nnw ##5 \s__whu_mark }
          { \__whu_specified_cbl_split:nnw {} {} ##5 \s__whu_mark }
        \tl_gset:Nn \tocthepage {##6}
        \__whu_if_head_int_dec:nTF { \tocthepage }
          { \cs_gset_eq:NN \tocifpageisnumber \use_i:nn }
          { \cs_gset_eq:NN \tocifpageisnumber \use_ii:nn }
        \tl_gset:Nn \toctheanchor {##7}
        \__whu_specified_cbl_code: 
      }
    \cs_set_eq:NN \tocifheadentry \use_i:nn
    \cs_set_eq:NN \tociftailentry \use_ii:nn
    \cs_set_protected:Npn \toclink { \whu_ref_target:nn \toctheanchor }
    \cs_set_protected:Npn \toclinkbox { \whu_ref_target_box:nn \toctheanchor }
    \cs_set:Npn \tocretinfo { \prop_item:Nn \toctheprop }
    \cs_set:Npn \whu@cbl@contentsline  { \whu@toc@contentsline }
    \cs_set:Npn \whu@type@contentsline { \whu@toc@contentsline }
    \int_step_inline:nnn \l__whu_cbl_search_min_int \l__whu_cbl_search_max_int
      { \cs:w whu/cbl~ \tl_if_empty:nTF {#1} { /cbl~ } { /type~#1 } /entry [##1] _tl \cs_end: {##1} }
    \whu@toc@contentsline@end 
  }
\cs_new:Npn \__whu_specified_cbl_split:nnw #1#2#3 \s__whu_mark 
  {
    \tl_gset:Nn \tocthenumber {#2}
    \tl_if_empty:NTF \tocthenumber 
      { \cs_gset_eq:NN \tocifnumbered \use_ii:nn }
      { \cs_gset_eq:NN \tocifnumbered \use_i:nn }
    \tl_gset:Nn \tocthename {#3}
  }
\cs_new:Npn \__whu_specified_cbl_info:w #1 , #2 \s__whu_mark 
  {
    \tl_gset:Nn \toctheclass {#1}
    \prop_gclear_new:N \toctheinfo 
    \clist_map_inline:nn {#2} { \prop_gput:Nnn \toctheinfo ##1 }
  }
\cs_new:Npn \__whu_specified_cbl_set_special_cs:n #1
  {
    \cs_set_eq:NN \? \g_whu_document_cbl_index_int 
    \bool_lazy_or:nnTF 
      { \tl_if_empty_p:n {#1} } { \int_compare_p:nNn { \? } < { 1 } }
      { \cs_set_eq:NN \$ \? }
      { 
        \bool_set_true:N \l__whu_tmpa_bool 
        \int_set_eq:NN \l__whu_tmpa_int \?
        \bool_while_do:Nn \l__whu_tmpa_bool 
          { 
            \whu_contents_get:nN \l__whu_tmpa_int \l__whu_tmpa_tl 
            \quark_if_no_value:NTF \l__whu_tmpa_tl 
              { 
                \cs_set:Npx \$ { 0 }
                \bool_set_false:N \l__whu_tmpa_bool 
              }
              {
                \str_if_eq:eeTF
                  { \tl_item:Nn \l__whu_tmpa_tl { 2 } } {#1}
                  { 
                    \cs_set:Npx \$ { \tl_item:Nn \l__whu_tmpa_tl { 3 } }
                    \bool_set_false:N \l__whu_tmpa_bool 
                  }
                  {
                    \if_int_compare:w \l__whu_tmpa_int = \c_one_int 
                      \cs_set:Npx \$ { 0 }
                      \bool_set_false:N \l__whu_tmpa_bool 
                    \else:
                      \int_decr:N \l__whu_tmpa_int 
                    \fi:
                  }
              }
          }
      }
  }
\int_new:N \l__whu_cbl_search_min_int
\int_new:N \l__whu_cbl_search_max_int
\cs_new_protected:Npn \__whu_specified_cbl_search:n #1
  { \msg_error:nn {whu} {} } %!!TODO:
\cs_new_protected:Npn \__whu_specified_cbl_search_basic:nnn #1#2#3
  {
    \int_set:Nn \l__whu_tmpa_int {#3}
    \int_set:Nn \l__whu_tmpb_int { \whu_heading_level:n { #1-#2 } }
    \bool_set_true:N \l__whu_tmpa_bool
    \cs_set:Npn \whu@type@contentsline ##1##2##3##4##5##6##7##8
      {
        % 如果此时的 level > #2 ，说明在 #2 内部
        \int_compare:nNnTF {##4} > { \l__whu_tmpb_int }
          {
            \int_decr:N \l__whu_tmpa_int
            \if_int_compare:w \l__whu_tmpa_int < \c_one_int
              \int_set:Nn \l__whu_cbl_search_min_int \c_one_int
              \bool_set_false:N \l__whu_tmpa_bool
            \fi:
          }
          {
            \int_compare:nNnTF {##4} = { \l__whu_tmpb_int }
              {
                \__whu_if_head_int_dec:nTF {#2}
                  { \int_set_eq:NN \l__whu_cbl_search_min_int \l__whu_tmpa_int }
                  {
                    \str_if_eq:eeTF { \whu_clist_item_first:n {##3} } {#2}
                      { \int_set_eq:NN \l__whu_cbl_search_min_int \l__whu_tmpa_int }
                      { \int_set:Nn \l__whu_cbl_search_min_int \c_max_int }
                  }
              }
              {
                \int_set:Nn \l__whu_cbl_search_min_int \l__whu_tmpa_int 
              }
            \bool_set_false:N \l__whu_tmpa_bool
          }
      }
    \whu_contents_type_get:nnN {#1} {#3} \l__whu_tmpa_tl 
    \bool_lazy_or:nnTF 
      { \quark_if_no_value_p:N \l__whu_tmpa_tl }
      { \int_compare_p:nNn { \tl_item:Nn \l__whu_tmpa_tl { 5 } } < \l__whu_tmpb_int }
      { \int_set:Nn \l__whu_cbl_search_min_int { \c_max_int } }
      {
        \bool_while_do:Nn \l__whu_tmpa_bool
          { \tl_use:c { whu/cbl~/type~#1 /entry[\int_use:N \l__whu_tmpa_int]_tl } }
      }

    \int_set:Nn \l__whu_tmpa_int { #3+1 }
    \bool_set_true:N \l__whu_tmpa_bool
    \cs_set:Npn \whu@type@contentsline ##1##2##3##4##5##6##7##8
      {
        \int_compare:nNnTF {##4} > { \l__whu_tmpb_int }
          {
            \int_incr:N \l__whu_tmpa_int
            \if_int_compare:w
              \l__whu_tmpa_int > \use:c { g__whu_cbl_type~#1_count_int }
              \bool_set_false:N \l__whu_tmpa_bool
              \int_set:Nn \l__whu_cbl_search_max_int
                { \use:c { g__whu_cbl_type~#1_count_int } }
            \fi:
          }
          {
            \int_set:Nn \l__whu_cbl_search_max_int { \l__whu_tmpa_int - 1 }
            \bool_set_false:N \l__whu_tmpa_bool 
          }
      }
    \int_compare:nNnTF 
      { \l__whu_tmpa_int } > { \use:c { g__whu_cbl_type~#1_count_int } }
      { 
        \int_compare:nNnTF { \l__whu_cbl_search_min_int } > 
          { \use:c { g__whu_cbl_type~#1_count_int } }
          { \int_set:Nn \l__whu_cbl_search_max_int { -\c_max_int } }
          {
            \int_set:Nn \l__whu_cbl_search_max_int 
              { \use:c { g__whu_cbl_type~#1_count_int } } 
          }
      }
      {
        \bool_while_do:Nn \l__whu_tmpa_bool
          { \use:c { whu/cbl~/type~#1 /entry[\int_use:N \l__whu_tmpa_int]_tl } }
      }
    \int_compare:nNnT \l__whu_cbl_search_min_int > {#3}
      { \int_set:Nn \l__whu_cbl_search_max_int { -\c_max_int } }
  }
\cs_new:Npn \__whu_specified_cbl_search:nnn #1#2#3
  {
    \__whu_specified_cbl_search_basic:nnn {#1} {#2} {#3}
    \cs_set:Npn \whu@type@contentsline ##1##2##3##4##5##6##7##8
      { \tl_set:Nx \toclolevel { \int_max:nn { \toclolevel } {##4} } }
    \int_step_inline:nnn \l__whu_cbl_search_min_int \l__whu_cbl_search_max_int
      { \use:c { whu/cbl~/type~#1 /entry[##1]_tl } }
  }
\cs_new:Npn \__whu_specified_cbl_pos:n #1 % pos
  {
    \tl_if_exist:cTF { @toc@\tocthetype @\toctheclass @#1 }
      { \use:c { @toc@\tocthetype @\toctheclass @#1 } }
      { \use:c { @toc@\tocthetype @\tocthelevel @#1 } }
  }
\cs_new:Npn \__whu_specified_cbl_pos:nn #1#2 % level, pos
  {
    \int_compare:nNnTF { \whu_heading_level:nn { \tocthetype } { \toctheclass } }
      = {#1}
      { 
        \tl_if_exist:cTF { @toc@\tocthetype @\toctheclass @#2 }
          { \use:c { @toc@\tocthetype @\toctheclass @#2 } }
          { \use:c { @toc@\tocthetype @#1 @#2 } }
      }
      { \use:c { @toc@\tocthetype @#1 @#2 } }
  }
\cs_new_protected:Npn \__whu_specified_cbl_ifcomplement:TF
  { \exp_last_unbraced:Ne \tl_if_in:nnTF { { -1234567890 } { \tl_head:N \toctheclass } } }
\cs_new_protected:Npn \__whu_specified_cbl_code: 
  {
    \int_compare:nNnTF { \tocthelevel - 1 } > \toctheprevlevel 
      {
        \tociffirsttrue \tocifcomplementtrue 
        \tl_set_eq:NN \whu@toc@tmp \tocthelevel 
        \tocifheadentry 
          { \int_step_inline:nnn { \tochilevel } { \tocthelevel - 1 } }
          { \int_step_inline:nnn { \toctheprevlevel + 1 } { \tocthelevel - 1 } }
            {
              \tl_gset:Nn \tocthelevel {##1}
              \seq_gpush:Nn \toc@classes {##1}
              \__whu_specified_cbl_pos:nn {##1} { liststart }
              \seq_gpush:Nn \toc@classes {##1}
              \__whu_specified_cbl_pos:nn {##1} { blockstart }
              \__whu_specified_cbl_pos:nn {##1} { blockitem }
              \toc@setif {first} {##1} {1}
            }
        \tl_gset_eq:NN \tocthelevel \whu@toc@tmp 
        \tocifcomplementfalse 
        \seq_gpush:No \toc@classes \toctheclass 
        \__whu_specified_cbl_pos:n { liststart }
        \seq_gpush:No \toc@classes \toctheclass 
        \__whu_specified_cbl_pos:n { blockstart }
        \__whu_specified_cbl_pos:n { blockitem }
        \toc@setif {first} {\tocthelevel} {1}
      }
      { 
        \tocifcomplementfalse
        \int_compare:nNnTF { \tocthelevel - 1 } = \toctheprevlevel 
          {
            \tociffirsttrue 
            \seq_gpush:No \toc@classes \toctheclass 
            \__whu_specified_cbl_pos:n { liststart }
            \seq_gpush:No \toc@classes \toctheclass 
            \__whu_specified_cbl_pos:n { blockstart }
            \__whu_specified_cbl_pos:n { blockitem }
            \toc@setif {first} {\tocthelevel} {1}
          }
          {
            \tociffirstfalse 
            \seq_gpush:No \toc@classes \toctheclass 
            \__whu_specified_cbl_pos:n { blockstart } 
            \__whu_specified_cbl_pos:n { blockitem } 
            \toc@setif {first} {\tocthelevel} {0}
          }
      }

    \int_compare:nNnTF { \tocthelevel - 1 } > \tocthenextlevel 
      {
        \tocifcomplementfalse 
        \toc@if {first} {\tocthelevel} { \tociffirsttrue } { \tociffirstfalse }
        \seq_gpop:NN \toc@classes \toctheclass 
        \__whu_specified_cbl_pos:n { blockfinish }
        \tociffirstfalse 
        \seq_gpop:NN \toc@classes \toctheclass 
        \__whu_specified_cbl_ifcomplement:TF 
          { \tocifcomplementtrue } { \tocifcomplementfalse }
        \__whu_specified_cbl_pos:n { listfinish }
        \toc@setif {first} {\tocthelevel} {0}
        \tociftailentry 
          { 
            \int_step_inline:nnnn { \tocthelevel - 1 } { -1 } { \tochilevel }
              {
                \tl_gset:Nn \tocthelevel {##1}
                \toc@if {first} {##1} { \tociffirsttrue } { \tociffirstfalse }
                \seq_gpop:NN \toc@classes \toctheclass 
                \__whu_specified_cbl_ifcomplement:TF 
                  { \tocifcomplementtrue } { \tocifcomplementfalse }
                  \__whu_specified_cbl_pos:nn {##1} { blockfinish }
                \tociffirstfalse 
                \seq_gpop:NN \toc@classes \toctheclass 
                \__whu_specified_cbl_ifcomplement:TF 
                  { \tocifcomplementtrue } { \tocifcomplementfalse }
                \__whu_specified_cbl_pos:nn {##1} { listfinish }
                \toc@setif {first} {##1} {0}
              }
          }
          {
            \int_step_inline:nnnn { \tocthelevel - 1 } { -1 } { \tocthenextlevel + 1 }
              {
                \tl_gset:Nn \tocthelevel {##1}
                \toc@if {first} {##1} { \tociffirsttrue } { \tociffirstfalse }
                \seq_gpop:NN \toc@classes \toctheclass 
                \__whu_specified_cbl_ifcomplement:TF 
                  { \tocifcomplementtrue } { \tocifcomplementfalse }
                \__whu_specified_cbl_pos:nn {##1} { blockfinish }
                \tociffirstfalse 
                \seq_gpop:NN \toc@classes \toctheclass 
                \__whu_specified_cbl_ifcomplement:TF 
                  { \tocifcomplementtrue } { \tocifcomplementfalse }
                \__whu_specified_cbl_pos:nn {##1} { listfinish }
                \toc@setif {first} {##1} {0}
              }
            \tl_gset_eq:NN \tocthelevel \tocthenextlevel
            \toc@if {first} {\tocthelevel} { \tociffirsttrue } { \tociffirstfalse }
            \seq_gpop:NN \toc@classes \toctheclass 
            \tocifcomplementfalse 
            \__whu_specified_cbl_pos:n { blockfinish } 
            \toc@setif {first} {\tocthelevel} {0}
          }
      }
      {
        \int_compare:nNnTF { \tocthelevel - 1 } = { \tocthenextlevel }
          {
            \toc@if {first} {\tocthelevel} { \tociffirsttrue } { \tociffirstfalse }
            \seq_gpop:NN \toc@classes \toctheclass
            \tocifcomplementfalse 
            \__whu_specified_cbl_pos:n { blockfinish }
            \tociffirstfalse 
            \seq_gpop:NN \toc@classes \toctheclass
            \__whu_specified_cbl_ifcomplement:TF 
              { \tocifcomplementtrue } { \tocifcomplementfalse }
            \__whu_specified_cbl_pos:n { listfinish }
            \toc@setif {first} {\tocthelevel} {0}
            \tl_gset_eq:NN \tocthelevel \tocthenextlevel 
            \toc@if {first} {\tocthelevel} { \tociffirsttrue } { \tociffirstfalse }
            \seq_gpop:NN \toc@classes \toctheclass 
            \__whu_specified_cbl_ifcomplement:TF 
              { \tocifcomplementtrue } { \tocifcomplementfalse }
            \__whu_specified_cbl_pos:nn { \tocthenextlevel } { blockfinish }
            \toc@setif {first} {\tocthelevel} {0}
          }
          {
            \int_compare:nNnTF \tocthelevel = \tocthenextlevel 
              {
                \toc@if {first} {\tocthelevel} { \tociffirsttrue } { \tociffirstfalse }
                \seq_gpop:NN \toc@classes \toctheclass 
                \__whu_specified_cbl_pos:n { blockfinish }
                \toc@setif {first} {\tocthelevel} {0}
              }
              { }
          }
      }
  }
\tl_const:Nn \whu@toc@contentsline@begin 
  {
    \cs_set_protected:Npn \tociffirsttrue { \cs_gset_eq:NN \tociffirst \use_i:nn }
    \cs_set_protected:Npn \tociffirstfalse { \cs_gset_eq:NN \tociffirst \use_ii:nn }
    \cs_set_protected:Npn \tocifcomplementtrue { \cs_gset_eq:NN \tocifcomplement \use_i:nn }
    \cs_set_protected:Npn \tocifcomplementfalse { \cs_gset_eq:NN \tocifcomplement \use_ii:nn }
    \tociffirsttrue 
    \int_step_inline:nnn { \tochilevel } { \toclolevel }
      { 
        \bool_set_eq:cN { @toc@complement@ #1 } \c_false_bool 
        \bool_set_eq:cN { @toc@first@ #1 } \c_true_bool
      }
    \cs_set:Npn \toc@if #1#2 { \bool_if:cTF { @toc@#1@#2 } }
    \cs_set_protected:Npn \toc@setif #1#2#3 
      { 
        \int_if_odd:nTF {#3}
          { \bool_gset_true:c { @toc@#1@#2 } }
          { \bool_gset_false:c { @toc@#1@#2 } }
      }
    \seq_clear:N \toc@classes 
  }
\tl_const:Nn \whu@toc@contentsline@end 
  {
    \tl_map_function:nN
      {
        \tocthetype \tocthecount \tocthelevel \tocthepage \toctheanchor 
        \tocthenumber \tocthename \toctheclass 
        \toctheinfo \tocretinfo \toctheindex 
        \tocthepreventry \toctheprevlevel \tocthenextentry \tocthenextlevel 
        \toclink \toclinkbox \tocifcomplement 
        \tociffirst \tocifnumbered \tocifpageisnumber \tocifheadentry \tociftailentry 
        \whu@toc@contentsline 
      }
      \cs_undefine:N
  }
\cs_new_protected_nopar:Npn \whu_get_cbl_level_range:nnnNN #1#2#3#4#5
  {
    \group_begin:
    \tl_set:Nx \tochilevel { \use:c { whu/cbl~/type~#1 /hi_used_level_tl } }
    \__whu_specified_cbl_set_special_cs:n {#1}
    \use:e { \__whu_specified_cbl_search_basic:nnn {#1} {#2} } {#3}
    \use:e 
      {
        \group_end:
        \tl_set:Nx \exp_not:N #4 { \int_use:N \l__whu_cbl_search_min_int }
        \tl_set:Nx \exp_not:N #5 { \int_use:N \l__whu_cbl_search_max_int }
      }
  }
\NewDocumentCommand \getcbllevelrange { m m O{} m m }
  {
    \use:e 
      {
        \whu_get_cbl_level_range:nnnNN 
          {#1} {#2} 
          { \tl_if_blank:nTF {#3} { \exp_not:N \$ } { \exp_not:n {#3} } }
      }
          #4 #5
  }
\NewDocumentCommand \SetSpecifiedCombinedListStyle { O{}+m+m+m+m+m+m }
  {
    \bool_if:NTF \l__whu_specified_cbl_save_bool 
      {
        \cs_set:Npn \__whu_set_specified_combinedlist_style:w ##1##2
          { 
            \whu_specified_cbl_style_save:nnnnnnnN 
              {##1} {##2} {#3} {#4} {#5} {#6} {#7} \g__whu_specified_style_tl 
          }
      }
      {
        \cs_set:Npn \__whu_set_specified_combinedlist_style:w ##1##2
          { 
            \whu_specified_cbl_style:nnnnnnn 
              {##1} {##2} {#3} {#4} {#5} {#6} {#7} 
          }
      }
    \bool_lazy_or:nnTF { \tl_if_empty_p:n {#1} } { \str_if_eq_p:nn {#1} {*} }
      { \seq_map_inline:Nn \g__whu_cbl_type_seq }
      { \clist_map_inline:nn {#1} }
        { 
          \clist_map_inline:nn {#2}
            { \__whu_set_specified_combinedlist_style:w {##1} {####1} }
        }
  }
\bool_new:N \l__whu_specified_cbl_save_bool 
\cs_new_protected:Npn \__whu_saveto_specified_cbl_style:n
  { \tl_build_put_right:Nn \g__whu_specified_style_tl }
\NewDocumentCommand \SaveSpecifiedCombinedListStyle { m +m }
  {
    \@bsphack
    \cs_set_eq:cN { __whu/saved/+ } \+
    \cs_set_eq:NN \+ \__whu_saveto_specified_cbl_style:n
    \bool_set_true:N \l__whu_specified_cbl_save_bool 
    \tl_build_begin:N \g__whu_specified_style_tl 
    #2 
    \tl_build_end:N \g__whu_specified_style_tl
    \tl_set_eq:NN #1 \g__whu_specified_style_tl
    \bool_set_false:N \l__whu_specified_cbl_save_bool 
    \cs_set_eq:Nc \+ { __whu/saved/+ }
    \@esphack 
  }
\NewDocumentCommand \SpecifiedCombinedList { >{\TrimSpaces} O{} }
  { \whu_specified_cbl:n {#1} }
\NewDocumentCommand \LocalSpecifiedCombinedList 
  { >{\TrimSpaces} O{} >{\SplitArgument{1}{,}} D(){,} }
  { \whu_specified_cbl:nnn {#1} #2 }
\cs_new_protected:Npn \tocsetstyle { \SetSpecifiedCombinedListStyle [toc] }
\cs_new_protected:Npn \specifiedtoc { \SpecifiedCombinedList [toc] }
\cs_new_protected:Npn \localspecifiedtoc { \LocalSpecifiedCombinedList [toc] }
\cs_new_protected:Npn \lofsetstyle { \SetSpecifiedCombinedListStyle [lof] {figure} }
\cs_new_protected:Npn \specifiedlof { \SpecifiedCombinedList [lof] }
\cs_new_protected:Npn \lotsetstyle { \SetSpecifiedCombinedListStyle [lot] {table} }
\cs_new_protected:Npn \specifiedlot { \SpecifiedCombinedList [lot] }
\ExplSyntaxOff

\@namedef{l@toc/cbl/level -1}#1#2#3#4#5#6#7{%
  \ifnum \c@tocdepth >-2\relax
    \addpenalty{-\@highpenalty}%
    \addvspace{2.25em \@plus\p@}%
    \begingroup
      \setlength\@tempdima{3em}%
      \parindent \z@ \rightskip \@pnumwidth
      \parfillskip -\@pnumwidth
      {\leavevmode
       \large \bfseries {#5}\hfil
       \hb@xt@\@pnumwidth{\hss #6%
                          \kern-\p@\kern\p@}}\par
       \nobreak
         \global\@nobreaktrue
         \everypar{\global\@nobreakfalse\everypar{}}%
    \endgroup
  \fi}
\@namedef{l@toc/cbl/level 0}#1#2#3#4#5#6#7{%
  \ifnum \c@tocdepth >\m@ne
    \addpenalty{-\@highpenalty}%
    \vskip 1.0em \@plus\p@
    \begingroup
      \setlength\@tempdima{1.5em}%
      \parindent \z@ \rightskip \@pnumwidth
      \parfillskip -\@pnumwidth
      \leavevmode \bfseries
      \advance\leftskip\@tempdima
      \hskip -\leftskip
      {#5}\nobreak\hfil
      \nobreak\hb@xt@\@pnumwidth{\hss #6%
                                 \kern-\p@\kern\p@}\par
      \penalty\@highpenalty
    \endgroup
  \fi}
\def\@dottedtocline#1#2#3#4#5{%
  \ifnum #1>\c@tocdepth \else 
    \vskip \z@ \@plus.2\p@
    {\leftskip #2\relax \rightskip \@tocrmarg \parfillskip -\rightskip
      \parindent #2\relax\@afterindenttrue
      \interlinepenalty\@M
      \leavevmode
      \@tempdima #3\relax
      \advance\leftskip \@tempdima \null\nobreak\hskip -\leftskip
      {#4}\nobreak
      \leaders\hbox{$\m@th
        \mkern \@dotsep mu\hbox{.}\mkern \@dotsep
        mu$}\hfill
      \nobreak\hb@xt@\@pnumwidth{\hfil #5%
                                \kern-\p@\kern\p@}%
      \par}%
  \fi}
\@namedef{l@toc/cbl/level 1}#1#2#3#4#5#6#7{\@dottedtocline{1}{1.5em}{2.3em}{#5}{#6}}
\@namedef{l@toc/cbl/level 2}#1#2#3#4#5#6#7{\@dottedtocline{2}{3.8em}{3.2em}{#5}{#6}}
\@namedef{l@toc/cbl/level 3}#1#2#3#4#5#6#7{\@dottedtocline{3}{7.0em}{4.1em}{#5}{#6}}
\@namedef{l@toc/cbl/level 4}#1#2#3#4#5#6#7{\@dottedtocline{4}{10em}{5em}{#5}{#6}}
\@namedef{l@toc/cbl/level 5}#1#2#3#4#5#6#7{\@dottedtocline{5}{12em}{6em}{#5}{#6}}
\def\l@part#1#2{\@nameuse{l@toc/cbl/level -1}{}{}{}{}{#1}{#2}{}}
\def\l@chapter#1#2{\@nameuse{l@toc/cbl/level 0}{}{}{}{}{#1}{#2}{}}
\def\l@section#1#2{\@nameuse{l@toc/cbl/level 1}{}{}{}{}{#1}{#2}{}}
\def\l@subsection#1#2{\@nameuse{l@toc/cbl/level 2}{}{}{}{}{#1}{#2}{}}
\def\l@subsubsection#1#2{\@nameuse{l@toc/cbl/level 3}{}{}{}{}{#1}{#2}{}}
\def\l@paragraph#1#2{\@nameuse{l@toc/cbl/level 4}{}{}{}{}{#1}{#2}{}}
\def\l@subparagraph#1#2{\@nameuse{l@toc/cbl/level 5}{}{}{}{}{#1}{#2}{}}


\protected\def\localplaincombinedlist#1#2#3{%
  \begingroup 
  \@tempcnta #2\relax
  \ifnum\@tempcnta<\@ne \@tempcnta\@ne \fi 
  \advance\@tempcnta-\@ne
  \@tempcntb #3\relax 
  \if\relax#1\relax 
    \ifnum\@tempcntb>\total@cbl@count \@tempcntb\total@cbl@count \fi 
  \else 
    \ifnum\@tempcntb>\@nameuse{total@type#1@count} 
      \@tempcntb\@nameuse{total@type#1@count}
    \fi
  \fi 
  \if\relax#1\relax
    \loop 
      \ifnum\@tempcnta<\@tempcntb
        \advance\@tempcnta by\@ne
        \contents@entry{\the\@tempcnta}\repeat 
  \else 
    \loop 
      \ifnum\@tempcnta<\@tempcntb
        \advance\@tempcnta by\@ne
        \contents@typeentry{#1}{\the\@tempcnta}\repeat 
  \fi
  \endgroup}
\NewDocumentCommand\multicollocalplaincombinedlist
  { O{columns=2,outer-sep=0pt} m m m m }
  {\if@twocolumn
      \@restonecoltrue\onecolumn
    \else
      \@restonecolfalse
    \fi
    \protected@edef\@tempc{#2}%
    \if\relax\detokenize\expandafter{\@tempc}\relax\else \chapter{#2}\fi
    \startmulticolumns[#1]%
    \localplaincombinedlist{#3}{#4}{#5}%
    \stopmulticolumns
    \if@restonecol\twocolumn\fi}
\protected\def\plaincombinedlist#1{\localplaincombinedlist{#1}{-\maxdimen}{\maxdimen}}
\NewDocumentCommand\multicolplaincombinedlist{O{columns=2,outer-sep=0pt} m m}
  {\multicollocalplaincombinedlist[{#1}]{#2}{#3}{-\maxdimen}{\maxdimen}}

\let\@starttoc\plaincombinedlist
\DeclareRobustCommand\tableofcontents[1][columns=1]%[columns=2,outer-sep=0pt]
  {\multicolplaincombinedlist[{#1}]{\contentsname}{toc}}
\NewDocumentCommand\localtableofcontents
  { D(){,} O{columns=1} >{\SplitArgument{1}{,}} D(){#1} }
  {\loc@ltableofcontents#3%
    \multicollocalplaincombinedlist[{#2}]{\contentsname}{toc}{\@tempcbla}{\@tempcblb}}
\def\loc@ltableofcontents#1#2{%
  \IfNoValueTF{#1}{\def\@tempa{\CurrentTitleLevel}}
    {\edef\@tempa{\if\relax#1\relax \CurrentTitleLevel \else #1\fi}}%
  \IfNoValueTF{#2}{\def\@tempb{}}{\def\@tempb{#2}}%
  \expanded{\getcbllevelrange{toc}{\@tempa}[{\@tempb}]}{\@tempcbla}{\@tempcblb}}
\DeclareRobustCommand\listoffigures[1][columns=1]%[columns=2,outer-sep=0pt]
  {\multicolplaincombinedlist[{#1}]{\listfigurename}{lof}}
\DeclareRobustCommand\listoftables[1][columns=1]%[columns=2,outer-sep=0pt]
  {\multicolplaincombinedlist[{#1}]{\listtablename}{lot}}


%% modify placeins.sty
\def\@fb@botlist{\@botlist}
\def\@fb@topbarrier{\suppressfloats[t]}
\protected\def\AllowFloatBelowHeading{\def\@fb@botlist{}}
\protected\def\AllowFloatAboveHeading{\def\@fb@topbarrier{}}
\protected\def\FloatBarrier{\par\begingroup \let\@elt\relax
  \edef\@tempa{\@fb@botlist\@deferlist\@dbldeferlist}%
  \ifx\@tempa\@empty 
  \else
    \ifx\@fltovf\relax % my indicator of recursion
      \if@firstcolumn 
        \clearpage 
      \else 
        \null\newpage\FloatBarrier 
      \fi
    \else 
      \newpage \let\@fltovf\relax 
      \FloatBarrier % recurse once only
  \fi\fi \endgroup
  \@fb@topbarrier}
%%

\ExplSyntaxOn

\whu_new_psrrule_eq_cs:nnc { toc-level~-1 } { standard } { l@toc/cbl/level~-1 }
\whu_new_psrrule_eq_cs:nnc { toc-level~0 } { standard } { l@toc/cbl/level~0 }
\whu_new_psrrule_eq_cs:nnc { toc-level~1 } { standard } { l@toc/cbl/level~1 }
\whu_new_psrrule_eq_cs:nnc { toc-level~2 } { standard } { l@toc/cbl/level~2 }
\whu_new_psrrule_eq_cs:nnc { toc-level~3 } { standard } { l@toc/cbl/level~3 }
\whu_new_psrrule_eq_cs:nnc { toc-level~4 } { standard } { l@toc/cbl/level~4 }
\whu_new_psrrule_eq_cs:nnc { toc-level~5 } { standard } { l@toc/cbl/level~5 }
\whu_obey_psrrule:nn { toc-level~-1 } { standard }
\whu_obey_psrrule:nn { toc-level~0 } { standard }
\whu_obey_psrrule:nn { toc-level~1 } { standard }
\whu_obey_psrrule:nn { toc-level~2 } { standard }
\whu_obey_psrrule:nn { toc-level~3 } { standard }
\whu_obey_psrrule:nn { toc-level~4 } { standard }
\whu_obey_psrrule:nn { toc-level~5 } { standard }

\cs_new_protected:Npn \SetPlainTocLevelCode #1 #2
  {
    \whu_set_psrrule:nnn { toc-level~ \whu_heading_level:n { toc-#1 } } 
      { standard }
      {#2}
    \whu_obey_psrrule:nn { toc-level~ \whu_heading_level:n { toc-#1 } } { standard }
  }


\msg_new:nnn { whu } { title-class-unknown } { The~title~class~`#1'~unknown. }
\prop_new_linked:N \g__whu_title_href_prop 
\cs_new:Npn \whutitleanchor 
  { \whu_exp_args:NNe \prop_item:Nn \g__whu_title_href_prop }
\int_new:N \g_whu_title_int
\seq_new:N \g__whu_title_seq
\cs_new_eq:NN \ifintitle \use_ii:nn
\cs_new_eq:NN \ifincblentry \use_ii:nn
\prop_new:N \g__whu_title_info_prop
\prop_new:N \g__whu_title_info_stay_prop
\ekeysdeclarecmd \titleaddinfo { s m }
  { 
    \protected@edef \@tempa {#2}
    \bool_if:nTF {#1} 
      { \prop_gput:Non \g__whu_title_info_stay_prop }
      { \prop_gput:Non \g__whu_title_info_prop }
        \@tempa 
  }
\ekeysdeclarecmd \titleremoveinfo { s m }
  {
    \protected@edef \@tempa {#2}
    \bool_if:nTF {#1}
      { \prop_gremove:NV \g__whu_title_info_stay_prop }
      { \prop_gremove:NV \g__whu_title_info_prop }
        \@tempa 
  }
\ekeysdeclarecmd \titleremoveallinfo { s }
  {
    \bool_if:nTF {#1}
      { \prop_gclear:N \g__whu_title_info_stay_prop }
      { \prop_gclear:N \g__whu_title_info_prop }
  }
\cs_new_protected:Npn \IterateTitleList { \seq_map_inline:Nn \g__whu_title_seq }
\NewDocumentCommand \definetitle { m >{ \TrimSpaces } O{normal} +m } 
  { 
    \cs_if_exist:cF { title@class@ #2 }
      { \msg_error:nnn { whu } { title-class-unknown } {#2} }
    \exp_args:NNe \seq_if_in:NnF \g__whu_title_seq { \cs_to_str:N #1 }
      { \exp_args:Ne \__whu_define_title_initial:n { \cs_to_str:N #1 } }
    \exp_args:Nee \keys_define:nn { whu/title/ \cs_to_str:N #1 } 
      { \exp_not:v { title@classkeys@#2 } }
    \str_gset:cx { title~parameter@ \cs_to_str:N #1 @__class } {#2}
    \exp_args:Nee \whu_setup_title:nn { \cs_to_str:N #1 }
      { \exp_not:v { title@classinitial@ #2 } , \exp_not:n {#3} }
    \use:c { title@classhook@#2afterdef }
    \use:e 
      {
        \__whu_title_declare_cmd:NnN 
          \exp_not:N #1 { \cs_to_str:N #1 } { \exp_not:c { title@class@ #2 } }
      }
  }
% title cmd, title name, class cmd 
\cs_new_protected:Npn \__whu_title_declare_cmd:NnN #1#2#3
  {
    \DeclareDocumentCommand #1 { s t- +O{} O{} m }
      {
        \__whu_title_initial:n {#2}
        \bool_if:NT ##2
          {
            \whu_setup_title:nn {#2} { mode=nonumber }
            \__whu_store_title_setting_key:nnn {#2} { mode } { }
          }
        \tl_if_blank:nTF {##4}
          {
            \whu_if_keyval_variable:nNnn {##3}
              \l__whu_title_curr_keys_tl
              {
                \__whu_title_full:onnnnn \l__whu_title_curr_keys_tl
                  {#2} {#3} {##1} {##5} {##5}
              }
              {
                \tl_if_empty:NTF \l__whu_title_curr_keys_tl
                  { \__whu_title_normal:nnnnn {#2} {#3} {##1} {##5} {##5} }
                  { \__whu_title_normal:nnnnn {#2} {#3} {##1} {##3} {##5} }
              }
          }
          { \__whu_title_full:nnnnnn {##3} {#2} {#3} {##1} {##4} {##5} }
        \__whu_restore_title_setting:n {#2}
        \__whu_title_ending:
        \ignorespaces
      }
  }
% key, title str, class, star or else, entry, title 
\cs_new_protected:Npn \__whu_title_full:nnnnnn #1#2 
  {
    \__whu_store_title_setting:nn {#2} {#1}
    \whu_setup_title:nn {#2} {#1}
    \__whu_title_normal:nnnnn {#2} 
  }
\cs_new_protected:Npn \__whu_title_full:onnnnn 
  { \exp_args:No \__whu_title_full:nnnnnn }
% title str, class, star or else, entry, title 
\cs_new_protected:Npn \__whu_title_normal:nnnnn #1#2#3#4#5
  {
    \use:e 
      { 
        \exp_not:n {#2} 
        {#1} {#3} 
        { \tl_if_blank:nTF {#4} { \exp_not:n {#5} } { \exp_not:n {#4} } } 
      } 
        {#5}
  }
\NewDocumentCommand \setuptitle { O{*} +m }
  {
    \seq_set_from_clist:Nn \l__whu_tmpa_seq {#1}
    \seq_if_in:NnTF \l__whu_tmpa_seq { * }
      { \seq_map_inline:Nn \g__whu_title_seq }
      { \seq_map_inline:Nn \l__whu_tmpa_seq }
        { \setuponetitle {##1} {#2} }
  }
\cs_new_protected:Npn \whu_setup_title:nn #1 { \keys_set:nn { whu/title/#1 } }
\cs_new_protected:Npn \whu_title_level_do:nn #1#2
  {
    \cs_set:Npn \__whu_title_level_do:n ##1 {#2}
    \seq_map_inline:Nn \g__whu_title_seq
      {
        \int_compare:nNnT {#1} = { \use:c { title~parameter@ ##1 @level } }
          { \__whu_title_level_do:n {##1} }
      }
  }
\cs_new_protected_nopar:Npn \setuponetitleq #1 { \whu_setup_title:nn {#1} }
\cs_new_protected:Npn \setuponetitle #1#2
  {
    \whu_if_head_int:nTF {#1}
      { 
        \exp_args:Nf \whu_title_level_do:nn { \int_eval:n {#1} } 
          { \whu_setup_title:nn {##1} {#2} }
      }
      { 
        \cs_if_exist:cTF {#1}
          { \whu_setup_title:nn {#1} {#2} }
          { \msg_warning:nnx { whu } { unknown-title } { \c_backslash_str #1 } }
      }
  }
\msg_new:nnn { whu } { unknown-title } { Unknown~title~command:~#1. }

\cs_new_protected:Npn \__whu_define_title_initial:n #1
  {
    \int_if_exist:cTF { c@ #1 } 
      {
        \exp_args:Nc \e@alloc@chardef { title~parameter@#1@__counter_number }
          \whu_get_register_num:cn { c@ #1 } { int } \exp_stop_f:
      }
      { 
        \newcounter {#1} 
        \exp_args:Nc \e@alloc@chardef { title~parameter@#1@__counter_number } \allocationnumber 
      }
    \int_zero:c { c@ #1 }
    \seq_put_right:Nx \g__whu_title_seq { #1 } 
    % 需要定义 toclevel@#1 , 用于 bookmark
    \tl_set:cx { toclevel@ #1 } { \exp_not:c { title~parameter@ #1 @level } }
    \exp_args:Ne \__whu_define_title_keys:n { #1 }
    \clist_new:c { title~parameter@#1@info }
    \tl_new:c { title~parameter@pre #1 }
    \tl_new:c { title~parameter@post #1 }
    \tl_const:cx { titlethe #1 }
      {
        \exp_not:c { title~parameter@pre #1 }
        \exp_not:c { title~parameter@the #1 }
        \exp_not:c { title~parameter@post #1 }
      }
    \tl_const:cx { title~parameter@ #1 name }
      {
        \group_begin:
          \exp_not:c { title~parameter@#1@nameformat }
            {
              \exp_not:c { title~parameter@pre #1 }
              \exp_not:N \tl_if_empty:NTF
              \exp_not:c { title~parameter@ #1 @numberformat }
                { \exp_not:c { title~parameter@the #1 } }
                {
                  \group_begin:
                    \exp_not:c { title~parameter@ #1 @numberformat }
                    \exp_not:c { title~parameter@the #1 }
                  \group_end:
                }
              \exp_not:c { title~parameter@post #1 }
            }
        \group_end:
      }
  }
\keys_define:nn { whu } { title .meta:nn = { whu/title } {#1} }
\cs_new_nopar:Npn \titleinternalvalue #1 { \cs:w title~parameter@#1 \cs_end: }
\cs_new_protected:Npn \__whu_define_title_keys:n #1
  {
    \whu_setup_title_store_restore:nnN {#1}
      { 
        style, name, name-preto, name-appto, number, numbering, 
        number-from, number-within, number-without, 
        number-format, label-format,
        bookmark, bookmark* 
      }
      @ 
    \keys_define:nn { whu/title } { #1 .meta:nn = { whu/title/#1 } {##1} }
    \keys_define:nn { whu/title/ #1 }
      {
        style           .meta:n = {##1} ,
        name            .code:n = { \whu_assign_heading_name:nn {#1} {##1} } ,
        name-preto      .code:n = 
          { \tl_put_left:cn { title~parameter@pre #1 } {##1} } ,
        name-appto      .code:n = 
          { \tl_put_right:cn { title~parameter@post #1 } {##1} } ,
        number        .tl_set:c = title~parameter@the #1 ,
        number-from     .code:n = 
          \__whu_title_keys_preamble_set:nn { number-from }
            { \whu_assign_number_from:nn {#1} {##1} } ,
        number-within   .code:n = 
          \__whu_title_keys_preamble_set:nn { number-within }
            { \counterwithin {#1} {##1} \scan_stop: } ,
        number-without  .code:n = 
          \__whu_title_keys_preamble_set:nn { number-without }
            { \counterwithout {#1} {##1} \scan_stop: } ,
        number-format   .code:n = 
          \__whu_title_keys_preamble_set:nn { number-format }
            { \cs_set:cpn { the #1 } {##1} } ,
        label-format    .code:n = 
          \__whu_title_keys_preamble_set:nn { label-format }
            { \labelformat {#1} { ##1 } } ,
        beforeskip   .tl_set:c = title~parameter@#1@beforeskip ,
        afterskip    .tl_set:c = title~parameter@#1@afterskip ,
        leftskip     .tl_set:c = title~parameter@#1@leftskip ,
        rightskip    .tl_set:c = title~parameter@#1@rightskip ,
        indent       .tl_set:c = title~parameter@#1@indent ,
        numbering     .choice: ,
        numbering / true .code:n = \__whu_title_set_mode:nn {#1} { normal } ,
        numbering / yes  .code:n = \__whu_title_set_mode:nn {#1} { normal } ,
        numbering / one  .code:n = \__whu_title_set_mode:nn {#1} { normal } ,
        numbering / false.code:n = \__whu_title_set_mode:nn {#1} { nonumber } ,
        numbering / no   .code:n = \__whu_title_set_mode:nn {#1} { nonumber } ,
        numbering / off  .code:n = \__whu_title_set_mode:nn {#1} { nonumber } ,
        numbering     .default:n = true ,
        mode            .code:n = \__whu_title_set_mode:nn {#1} {##1} ,
        mode         .initial:n = normal ,
        beforeskip   .initial:n = \c_zero_skip ,
        afterskip    .initial:n = \c_zero_skip ,
        leftskip     .initial:n = \c_zero_skip ,
        rightskip    .initial:n = \c_zero_skip ,
        indent       .initial:n = \c_zero_dim ,
        afterindent .switch_set:c = title~parameter@#1@afterindent ,
        fixskip     .switch_set:c = title~parameter@#1@fixskip ,
        ensureskip  .switch_set:c = title~parameter@#1@ensureskip ,
        hang        .switch_set:c = title~parameter@#1@hang ,
        hang           .initial:n = true ,
        runin       .switch_set:c = title~parameter@#1@runin ,
        float-barrier .switch_set:c = title~parameter@#1@floatbarrier ,
        pagestyle   .tl_set_e:c = title~parameter@#1@pagestyle ,
        pagestyle    .initial:n = plain ,
        mark          .tl_set:c = title~parameter@#1@mark ,
        mark         .initial:n = \use_none:n ,
        level           .code:n = 
          \__whu_title_keys_preamble_set:nn { title~level }
            { \whu_assign_heading_level:nn {#1} {##1} } ,
        beforerecord  .tl_set:c = { title~parameter@#1@beforerecord } ,
        beforerecord>   .code:n = \tl_put_left:cn 
          { title~parameter@#1@beforerecord } {##1} ,
        beforerecord<   .code:n = \tl_put_right:cn 
          { title~parameter@#1@beforerecord } {##1} ,
        tocline      .cs_set:cp = { title~parameter@#1@tocline } ##1##2 ,
        tocline      .initial:n = \titlenumberline{##1}##2 ,
        properties .clist_set:c = { title~parameter@#1@properties } ,
        properties+ .code:n = \clist_put_right:cn 
          { title~parameter@#1@properties } {##1} ,
        bookmark*       .code:n = \whu_gset_next_bookmark_text:n {##1} ,
        bookmark        .code:n = 
          \whu_gset_next_bookmark_text:n 
            { \legacy_if:nT { BKM@numbered } { \tl_use:c { titlethe #1 } ~ } ##1 } ,
        break         .tl_set:c = title~parameter@#1@break ,
        break+          .code:n = \tl_put_right:cn { title~parameter@#1@break } {##1} ,
        format        .tl_set:c = title~parameter@#1@format ,
        format+         .code:n = \tl_put_right:cn { title~parameter@#1@format } {##1} ,
        nameformat    .tl_set:c = title~parameter@#1@nameformat ,
        nameformat+     .code:n = \tl_put_right:cn { title~parameter@#1@nameformat } {##1} ,
        numberformat  .tl_set:c = title~parameter@#1@numberformat ,
        numberformat+   .code:n = \tl_put_right:cn { title~parameter@#1@numberformat } {##1} ,
        titleformat   .tl_set:c = title~parameter@#1@titleformat ,
        titleformat+    .code:n = \tl_put_right:cn { title~parameter@#1@titleformat } {##1} ,
        aftername     .tl_set:c = title~parameter@#1@aftername ,
        aftername+      .code:n = \tl_put_right:cn { title~parameter@#1@aftername } {##1} ,
        aftertitle    .tl_set:c = title~parameter@#1@aftertitle ,
        aftertitle+     .code:n = \tl_put_right:cn { title~parameter@#1@aftertitle } {##1} ,
      }
  }
%\seq_const_from_clist:Nn \c__whu_store_key_seq
%  {
%    beforeskip, afterskip, indent, numbering, afterindent, fixskip, hang, runin,
%    pagestyle, mark, level, tocline, break, format, nameformat, numberformat,
%    titleformat, aftername, aftertitle
%  }
\seq_new:N \l__whu_title_restore_key_seq
\cs_new_protected:Npn \__whu_title_initial:n #1
  { 
    \int_gincr:N \g_whu_title_int
    \seq_clear:N \l__whu_title_restore_key_seq 
    \tl_gset:Nx \CurrentTitleLevel { \tl_use:c { title~parameter@ #1 @level } }
    \tl_gset:Nn \CurrentTitleName  {#1}
    \cs_set_eq:NN \ifintitle \use_i:nn
  }
\tl_const:Nn \thetitlecount { \int_use:N \g_whu_title_int }
\def\@titlecount@last{-\maxdimen} \def\PreviousTitleCount{0}
\whu_hook_gput_ae:n 
  { \ifnum\@titlecount@last>\z@ \xdef\PreviousTitleCount{\@titlecount@last}\fi }
\tl_gput_left:Nn \@kernel@after@enddocument@afterlastpage
  { \iow_now:Ne \@auxout { \gdef\string\@titlecount@last{\thetitlecount} } }
\tl_gset:Nx \CurrentTitleLevel { -10001 }
\str_new:N \CurrentTitleName
\cs_new_protected:Npn \__whu_store_title_setting:nn #1#2
  {
    \keyval_parse:nnn
      { \whu_twiddle_N:nnn { \__whu_store_title_setting_key:nnn {#1} } { } }
      { \__whu_store_title_setting_key:nnn {#1} }
      {#2}
    \use:c { title~restore@#1@extra } % extra store code 
  }
\cs_new_protected:Npn \__whu_store_title_setting_key:nnn #1#2#3
  {
    \cs:w title~store@#1@#2@command \cs_end: % 可以通过它来改变 store 方法
    \__whu_store_title_setting_key:nn {#1} {#2}
  }
\cs_new_protected:Npn \__whu_store_title_setting_key:nn #1#2
  {
    \cs_if_exist:cT { title~parameter@#1@#2 }
      { 
        \seq_put_right:Nn \l__whu_title_restore_key_seq {#2}
        \cs_set_eq:cc { title~tmpstore@#1@#2 } { title~parameter@#1@#2 } 
      }
  }
\cs_new_protected:Npn \whu_set_title_key_store_code:nn #1
  { 
    \cs_set_protected:cpn { title~store@ #1 @command } 
      \__whu_store_title_setting_key:nn ##1##2
  }
\cs_new_protected_nopar:Npn \__whu_restore_title_setting:n #1
  {
    \seq_remove_duplicates:N \l__whu_title_restore_key_seq
    \seq_map_inline:Nn \l__whu_title_restore_key_seq
      {
        \cs:w title~restore@#1@##1@command \cs_end: % 可以通过它来改变 restore 方法
        \__whu_restore_title_setting_key:nn {#1} {##1}
      }
  }
\cs_new_protected:Npn \__whu_title_ending:
  {
    \prop_gclear:N \g__whu_title_info_prop
    \clist_gclear:c { title~parameter@ \CurrentTitleName @info }
    \cs_set_eq:NN \ifintitle \use_ii:nn
  }
\cs_new_protected:Npn \__whu_restore_title_setting_key:nn #1#2
  { \cs_set_eq:cc { title~parameter@#1@#2 } { title~tmpstore@#1@#2 } }
\cs_new_protected:Npn \whu_set_title_key_restore_code:nn #1
  {
    \cs_set_protected:cpn { title~restore@ #1 @command }
      \__whu_restore_title_setting_key:nn ##1##2
  }

\cs_new_protected:Npn \whu_setup_title_store_restore:nn #1
  { 
    \keyval_parse:nnn 
      { \__whu_setup_title_store_restore:nn {#1} } 
      { \__whu_setup_title_store_restore:nnn {#1} } 
  }
\cs_new:Npn \whu_setup_title_store_restore:n { \whu_setup_title_store_restore:nn { } }
\cs_new:Npn \__whu_setup_title_store_restore:nn #1#2
  { \__whu_setup_title_store_restore:nnnn {#1} {#2} { } { } }
\cs_new:Npn \__whu_setup_title_store_restore:nnn #1#2#3
  {
    % \bool_lazy_and:nnTF 
    %   { \tl_if_head_is_group_p:n {#3} }
    %   { \int_compare_p:nNn { 2 } = { \tl_count:n {#3} } }
    \tl_if_head_is_group:nTF {#3}
      { \__whu_setup_title_store_restore:nnnn {#1} {#2} #3 }
      { \__whu_setup_title_store_restore:nnN {#1} {#2} {#3} }
  }
\cs_new_protected:Npn \__whu_setup_title_store_restore:nnnn #1#2#3#4
  {
    \whu_set_title_key_store_code:nn   { #1@#2 } {#3}
    \whu_set_title_key_restore_code:nn { #1@#2 } {#4}
  }
\cs_new_protected:Npn \__whu_setup_title_store_restore:nnN #1#2#3
  {
    \use:c { __whu_setup_title_store_restore_ #3 :nn } {#1} {#2}
  }
\cs_new_protected:cpn { __whu_setup_title_store_restore_ :nn } #1#2
  { \__whu_setup_title_store_restore:nnnn {#1} {#2} { } { } }
\cs_new_protected:cpn { __whu_setup_title_store_restore_@:nn } #1#2
  {
    \cs_set_eq:cc { title~store@#1@#2@command } { title~store@@#2@command }
    \cs_set_eq:cc { title~restore@#1@#2@command } { title~restore@@#2@command }
  }
\cs_new_protected:cpn { __whu_setup_title_store_restore_&:nn } #1#2
  {
    \cs_set_eq:cN { title~store@#1@#2@command } \scan_stop:
    \cs_set_eq:cN { title~restore@#1@#2@command } \scan_stop:
  }
\cs_new_protected:Npn \whu_setup_title_store_restore:nnN #1#2#3
  {
    \clist_map_inline:nn {#2}
      { \__whu_setup_title_store_restore:nnN {#1} {##1} {#3} }
  }
\whu_setup_title_store_restore:n 
  {
    style ,
    number-from ,
    number-within ,
    number-without ,
    number-format ,
    label-format ,
    bookmark ,
    bookmark* ,

    , name=
      {
        \seq_put_right:Nn \l__whu_title_restore_key_seq { name }
        \cs_set_eq:cc { title~tmpstore@pre #1 } { title~parameter@pre #1 }
        \cs_set_eq:cc { title~tmpstore@post #1 } { title~parameter@post #1 }
      }
      {
        \cs_set_eq:cc { title~parameter@pre #1 } { title~tmpstore@pre #1 }
        \cs_set_eq:cc { title~parameter@post #1 } { title~tmpstore@post #1 }
      }
    , name-preto=
      {
        \seq_put_right:Nn \l__whu_title_restore_key_seq { name-preto }
        \cs_set_eq:cc { title~tmpstore@pre #1 } { title~parameter@pre #1 }
      }
      { \cs_set_eq:cc { title~parameter@pre #1 } { title~tmpstore@pre #1 } }
    , name-appto=
      {
        \seq_put_right:Nn \l__whu_title_restore_key_seq { name-appto }
        \cs_set_eq:cc { title~tmpstore@post #1 } { title~parameter@post #1 }
      }
      { \cs_set_eq:cc { title~parameter@post #1 } { title~tmpstore@post #1 } }
    , number=
      {
        \seq_put_right:Nn \l__whu_title_restore_key_seq { number }
        \cs_set_eq:cc { title~tmpstore@the #1 } { title~parameter@the #1 }
      }
      { \cs_set_eq:cc { title~parameter@the #1 } { title~tmpstore@the #1 } }
    , numbering=
      {
        \seq_put_right:Nn \l__whu_title_restore_key_seq { mode }
        \cs_set_eq:cc { title~tmpstore@#1@mode } { title~parameter@#1@mode }
      }
      { \cs_set_eq:cc { title~parameter@#1@mode } { title~tmpstore@#1@mode } }
  }

\cs_new_protected:Npn \__whu_title_keys_preamble_set:nn #1 % warning words, set code 
  {
    \whu_if_document_test:TF 
      { \msg_warning:nnn { whu } { document-reset-value } { #1 }  }
  }
\cs_new_protected:Npn \__whu_title_info_gput:nn #1#2
  { \clist_gput_right:cn { title~parameter@ \CurrentTitleName @info } { {#1}{#2} } }
% unstarred mode is odd 
\int_const:cn { title~constant@normal~mode } \c__whu_one_int
\int_const:cn { title~constant@unstarred~mode } \c__whu_one_int
\int_const:cn { title~constant@nonumber~mode } \c__whu_three_int
% starred mode is even 
\int_const:cn { title~constant@starred~mode } \c__whu_two_int
\cs_new_protected:Npn \__whu_title_set_mode:nn #1#2
  {
    \cs_if_exist:cTF { title~constant@#2~mode }
      { \cs_set_eq:cc { title~parameter@#1@mode } { title~constant@#2~mode } }
      { \msg_error:nnxx { whu } { title-unknown-mode } { \c_backslash_str #1 } {#2} }
  }
\msg_new:nnn { whu } { title-unknown-mode } 
  { Unknown~title~mode~`#2'~when~setting~#1. }
\cs_new:Npn \__whu_title_if_mode:nnTF #1#2 
  {
    \exp_after:wN \if_meaning:w \cs:w title~parameter@#1@mode \exp_after:wN \cs_end:
      \cs:w title~constant@#2~mode \cs_end:
      \exp_after:wN \use_i:nn
    \else: \exp_after:wN \use_ii:nn
    \fi:
  }
% see \str_case:nnTF, ect.
\cs_new:Npn \__whu_title_mode_case:nnTF #1#2#3#4
  {
    \exp:w \__whu_title_mode_case:nw {#1} #2 {#1} { }
      \s__whu_mark {#3} \s__whu_mark {#4} \s__whu_stop
  }
\cs_new:Npn \__whu_title_mode_case:nw #1#2#3
  {
    \__whu_title_if_mode:nnTF {#1} {#2}
      { \__whu_title_mode_case_end:nw {#3} }
      { \__whu_title_mode_case:nw {#1} }
  }
\cs_new:Npn \__whu_title_mode_case_end:nw #1#2#3 \s__str_mark #4#5 \s__str_stop
  { \exp_end: #1 #4 }
\NewDocumentCommand \whu_assign_heading_name:nn
  { m > { \SplitArgument { 1 } { , } } +m }
  { \__whu_assign_heading_name:nnn {#1} #2 }
\cs_new_protected:Npn \__whu_assign_heading_name:nnn #1#2#3
  {
    \tl_set:cn { title~parameter@pre #1 } {#2}
    \tl_if_novalue:nTF {#3}
      { \tl_clear:c { title~parameter@post #1 } }
      { \tl_set:cn { title~parameter@post #1 } {#3} }
  }
\cs_new_protected:Npn \whu_assign_heading_level:nn #1#2
  { \tl_set:cx { title~parameter@ #1 @level } { \whu_heading_level:n { toc-#2 } } }
\cs_new_protected:Npn \whu_assign_number_from:nn #1#2
  {
    \str_if_eq:eeTF {#1} {#2}
      {
        \exp_args:Ncc \tex_countdef:D { c@ #2 } { title~parameter@#1@__counter_number }
      }
      { 
        % 先前已经分配了 \c@#1 ，这里并不取消它
        \int_if_exist:cTF { c@ #2 } { \cs_set_eq:cc { c@ #1 } { c@ #2 } }
          { \msg_error:nnn { whu } { counter-unknown } {#2} }
      }
  }
\NewDocumentCommand \setsecnumberdepth { >{\TrimSpaces} m }
  { 
    \whu_if_head_int:nTF {#1} { \setcounter { secnumdepth } { \int_eval:n {#1} } }
      { \exp_args:Nnf \setcounter { secnumdepth } { \whu_heading_level:n { toc-#1 } } }
  }
\cs_new_protected_nopar:Npn \setsecnumdepth { \setsecnumberdepth }

% 判断是不是已经 patch 了
\cs_if_exist:NF \ctex_cleveref_hook:
  {
    \cs_new_protected:Npn \ctex_cleveref_hook:
      {
        \@ifpackageloaded { hyperref }
          {
            \@ifpackagewith { hyperref } { implicit = false }
              { }
              { \__ctex_cleveref_hook_aux:N \H@refstepcounter }
          }
          {
            \__ctex_cleveref_hook_aux:N \refstepcounter@noarg
            \__ctex_cleveref_hook_aux:N \refstepcounter@optarg
          }
      }
    \cs_new_protected:Npn \__ctex_cleveref_hook_aux:N #1
      {
        \ctex_patch_cmd_all:NnnnTF #1
          {
            \ExplSyntaxOff
            \char_set_catcode_letter:n { 64 }
          }
          { \endcsname \csname the }
          { \expandafter \endcsname \csname the }
          { }
          { \ctex_patch_failure:N #1 }
      }
    \whu_pkg_code:nnn { cleveref } { } { \ctex_cleveref_hook: }
  }

\msg_new:nnn { whu } { document-reset-value } { Cannot~set~#1~after~preamble. }

\cs_new_eq:NN \CurrentCombinedListCount \g_whu_document_cbl_index_int 
\int_new:N \g__whu_curr_toc_default_level_count_int
\cs_new_eq:NN \CurrentTocDefaultLevelCount \g__whu_curr_toc_default_level_count_int
\cs_new_protected:Npn \whu@updatedefaultlevel #1#2
  {
    \str_if_eq:eeT {#1} { toc }
      { 
        \if_int_compare:w \exp_args:Ne \whu_heading_level:n { toc-#2 } = \c_zero_int
          \int_gincr:N \g__whu_curr_toc_default_level_count_int
        \fi:
      }
  }
\group_begin:
\char_set_catcode_other:N \#
\whu_hook_gput_ae:n 
  {
    \ctex_appto_cmd:NnnTF \addcontentsline { \makeatletter }
      { \whu@updatedefaultlevel{#1}{#2} }
      { }
      { \whu_patch_failure:N \addcontentsline }
  }
\group_end:
\skip_new:N \title@headingskip
\cs_new:Npn \title@mark #1 
  { \cs:w title~parameter@ \CurrentTitleName @mark \cs_end: {#1} }
\cs_new:Npn \title@floatbarrier #1 { }
\cs_new:Npn \title@break
  { \cs:w title~parameter@ \CurrentTitleName @break \cs_end: }
\cs_new:Npn \title@pagestyle
  { 
    \tl_if_empty:cF { title~parameter@ \CurrentTitleName @pagestyle } 
      { \exp_args:Nv \usethispagestyle { title~parameter@ \CurrentTitleName @pagestyle } }
  }
\cs_new:Npn \title@setheadingskip #1
  { \skip_set:Nn \title@headingskip { \tl_use:c { title~parameter@ \CurrentTitleName @#1skip } } }
\cs_new:Npn \title@iffixskip
  { \bool_if:cTF { title~parameter@ \CurrentTitleName @fixskip } }
\cs_new:Npn \title@ifensureskip
  { \bool_if:cTF { title~parameter@ \CurrentTitleName @ensureskip } }
\cs_new:Npn \title@fixheadingskip
  {
    \par 
    \dim_set:Nn \tex_prevdepth:D { -1000pt }
    \skip_sub:Nn \title@headingskip { \tex_parskip:D }
  }
\cs_new:Npn \title@fixtopskip 
  {
    \title@fixheadingskip 
    \dim_compare:nNnF \tex_pagegoal:D < \c_max_dim
      { \skip_sub:Nn \title@headingskip { \tex_topskip:D } }
  }
\cs_new:Npn \title@ifnumbering #1#2
  { \title@ifmode { \CurrentTitleName } { nonumber } {#2} {#1} }
\cs_new:Npn \title@ifmode { \__whu_title_if_mode:nnTF }
\cs_new:Npn \title@modecase { \__whu_title_mode_case:nnTF }
\cs_new_protected:Npn \title@makeanchor { \whu_make_unique_target:n }
\cs_new:Npn \title@gettitle #1 { }
\whu_pkg_code:nnn { nameref } { }
  { \cs_gset_protected:Npn \title@gettitle { \NR@gettitle } }
\cs_new:Npn \title@beforerecord
  { 
    \use:c { title~parameter@ \CurrentTitleName @beforerecord } 
    \prop_gput:Nxx \g__whu_title_href_prop 
      { \int_use:N \g_whu_title_int } { \@currentHref }
  }
\cs_new:Npn \title@recordproperties
  {
    \property_record:ee 
      { whu.title. \int_use:N \g_whu_title_int }
      { \exp_not:v { title~parameter@ \CurrentTitleName @properties } }
  }
\cs_new:Npn \__whu_if_incsname:TF 
  { \tex_ifincsname:D \exp_after:wN \use_i:nn \else: \exp_after:wN \use_ii:nn \fi: }
\cs_new:Npn \title@addtocline #1
  {
    \prop_gconcat:NNN \g__whu_title_info_prop
      \g__whu_title_info_stay_prop \g__whu_title_info_prop
    \prop_map_function:NN \g__whu_title_info_prop \__whu_title_info_gput:nn
    \addcontentsline {toc} 
      % bookmark needs #1 to determine level
      { 
        \CurrentTitleName \__whu_if_incsname:TF { } 
          { , \use:c { title~parameter@ \CurrentTitleName @info } } 
      } 
      { 
        \cs:w title~parameter@ \CurrentTitleName @tocline \exp_after:wN \cs_end: 
          \exp_after:wN { \CurrentTitleName } {#1} 
      } 
  }
\cs_new:Npn \title@heading@format@initial 
  {
    \normalfont
    \int_set:Nn \tex_interlinepenalty:D { 10000 }
    \tex_noindent:D 
  }
\cs_new:Npn \titleifname #1#2 {#2}
\cs_new:Npn \title@ifnametrue { \cs_set_eq:NN \titleifname \use_i:nn }
\cs_new:Npn \title@ifnamefalse { \cs_set_eq:NN \titleifname \use_ii:nn }
\cs_new:Npn \titleifmeasuring #1#2 {#2}
\cs_new:Npn \title@ifmeasuringtrue { \cs_set_eq:NN \titleifmeasuring \use_i:nn }
\cs_new:Npn \title@ifmeasuringfalse { \cs_set_eq:NN \titleifmeasuring \use_ii:nn }
\cs_new:Npn \title@format { \cs:w title~parameter@ \CurrentTitleName @format \cs_end: }
\cs_new:Npn \title@headinghang #1
  {
    \dim_set:Nn \tex_parindent:D { \title@getindent }
    \bool_if:cTF { title~parameter@ \CurrentTitleName @hang }
      {
        \tex_noindent:D 
        \hbox_set:Nn \l__whu_tmpa_box
          {
            \dim_compare:nNnF \tex_parindent:D = \c_zero_dim
              { \tex_indent:D }
            #1
          }
        \tex_hangindent:D = \box_wd:N \l__whu_tmpa_box
        \box_use_drop:N \l__whu_tmpa_box
      }
      {
        \dim_compare:nNnF \tex_parindent:D = \c_zero_dim
          { \tex_indent:D }
        #1
      }
  }
\cs_new:Npn \title@titleformat 
  { \cs:w title~parameter@ \CurrentTitleName @titleformat \cs_end: }
\cs_new:Npn \title@aftertitle 
  { \cs:w title~parameter@ \CurrentTitleName @aftertitle \cs_end: }
\cs_new:Npn \title@ifafterindent
  { \bool_if:cTF { title~parameter@ \CurrentTitleName @afterindent } }
\cs_new:Npn \title@name { \cs:w title~parameter@ \CurrentTitleName name \cs_end: }
\cs_new:Npn \title@aftername 
  { \cs:w title~parameter@ \CurrentTitleName @aftername \cs_end: }
\cs_new:Npn \title@getlevel
  { \cs:w title~parameter@ \CurrentTitleName @level \cs_end: }
\cs_new:Npn \title@ifrunin 
  { \bool_if:cTF { title~parameter@ \CurrentTitleName @runin } }
\cs_new:Npn \title@iffloatbarrier
  { \bool_if:cTF { title~parameter@ \CurrentTitleName @floatbarrier } }
\cs_new:Npn \title@indentbox #1
  {
    \dim_set:Nn \tex_parindent:D {#1}
    \dim_compare:nNnF \tex_parindent:D = \c_zero_dim { \tex_indent:D }
  }
\cs_new:Npn \title@getindent 
  { \cs:w title~parameter@ \CurrentTitleName @indent \cs_end: }

\whu_add_pdf_disable:n
  {
    \cs_set_eq:NN \par \c_space_tl
    \cs_set_eq:NN \\ \c_space_tl
  }
\cs_new_protected:Npn \title@setvarwidth #1#2#3
  { \collectn_set_vbox_varwidth:Nnw #1 {#2} #3 \collectn_set_vbox_varwidth_end: }
\ExplSyntaxOff

\let\hyper@nopatch@sectioning\@empty 
\let\NR@nopatch@sectioning\@empty

\def\title@ifstar#1{\ifnum
  \ifx\BooleanTrue#1\@empty 1\else 0\fi
  \title@ifmode\CurrentTitleName{starred}10=0
  \expandafter\@secondoftwo\else\expandafter\@firstoftwo\fi}

\newbox\title@box 
\newdimen\titlewidth 

% 例如：\part
\def\title@classkeys@page{}
\def\title@classinitial@page{pagestyle=plain,level=part,hang=false,}
\def\title@classhook@pagebegin{}
\def\title@classhook@pageend{}
\def\title@classhook@pageafterdef{}
\protected\def\title@class@page #1#2{%
  \title@break
  \title@classhook@pagebegin
  \title@pagestyle
  \if@twocolumn 
    \onecolumn
    \@tempswatrue
  \else 
    \@tempswafalse
  \fi 
  \title@setheadingskip{before}%
  \title@iffixskip{\title@fixtopskip}{}%
  \vspace*{\title@headingskip}%
  \title@ifstar{#2}{\title@class@page@@}{\title@class@page@}{#1}}
\protected\def\title@class@page@ #1#2#3{%
  \ifnum \c@secnumdepth >-2\relax
    \title@ifnumbering
      {\title@ifnametrue \refstepcounter{#1}}
      {\title@ifnamefalse \title@makeanchor{#1}}%
  \else 
    \title@ifnamefalse
    \title@makeanchor{#1}%
  \fi 
  \title@beforerecord
  \title@gettitle{#2}%
  \title@recordproperties
  \title@addtocline{#2}%
  \title@mark{#2}%
  \begingroup
    \title@heading@format@initial 
    \title@format{%
      \title@headinghang
        {\titleifname{\title@name\title@aftername}{}}%
      \title@titleformat{#3}%
      \title@aftertitle}\par 
  \endgroup
  \title@class@pageend{#1}}
\protected\def\title@class@page@@ #1#2#3{%
  \title@ifnamefalse 
  \title@makeanchor{#1}%
  \title@beforerecord
  \title@gettitle{#2}%
  \title@recordproperties
  \begingroup
    \title@heading@format@initial 
    \title@format{%
      \title@headinghang{}%
      \title@titleformat{#3}%
      \title@aftertitle}\par 
  \endgroup
  \title@class@pageend{#1}}
\protected\def\title@class@pageend #1{%
  \title@setheadingskip{after}%
  \title@iffixskip{\title@fixheadingskip}{}%
  \vskip\title@headingskip
  \title@classhook@pageend
  \newpage 
  \if@twoside
    \if@openright \null \thispagestyle{empty}\newpage \fi
  \fi 
  \if@tempswa \twocolumn \fi}
% 例如：\chapter 
\def\title@classkeys@top{}
\def\title@classinitial@top{pagestyle=plain,level=chapter,hang=false}
\def\title@classhook@topbegin{}
\def\title@classhook@topend{}
\def\title@classhook@topafterdef{}
\protected\def\title@class@top #1#2{%
  \title@break
  \title@classhook@topbegin
  \title@pagestyle
  \global\@topnum\z@ 
  \title@ifafterindent{\@afterindenttrue}{\@afterindentfalse}%
  \title@ifstar{#2}{\title@class@top@@}{\title@class@top@}{#1}}
\protected\def\title@class@top@ #1#2#3{%
  \ifnum \c@secnumdepth >\m@ne
    \if@mainmatter 
      \title@ifnumbering
        {\title@ifnametrue \refstepcounter{#1}}
        {\title@ifnamefalse \title@makeanchor{#1}}%
    \else 
      \title@ifnamefalse 
      \title@makeanchor{#1}%
    \fi 
  \else 
    \title@ifnamefalse 
    \title@makeanchor{#1}
  \fi 
  \title@beforerecord
  \title@gettitle{#2}%
  \title@recordproperties
  \title@addtocline{#2}%
  \title@mark{#2}%
  \if@twocolumn 
    \@topnewpage[\@maketophead{#1}{#3}]%
  \else 
    \@maketophead{#1}{#3}%
    \@afterheading
  \fi}
\protected\def\title@class@top@@ #1#2#3{%
  \title@ifnamefalse 
  \title@makeanchor{#1}%
  \title@beforerecord
  \title@gettitle{#2}%
  \title@recordproperties
  \if@twocolumn 
    \@topnewpage[\@makestophead{#1}{#3}]%
  \else 
    \@makestophead{#1}{#3}%
    \@afterheading
  \fi}
\protected\def\@maketophead #1#2{%
  \title@setheadingskip{before}%
  \title@iffixskip{\title@fixtopskip}{}%
  \vspace*{\title@headingskip}%
  \begingroup
    \title@heading@format@initial 
    \title@format{%
      \title@headinghang{\titleifname{\title@name\title@aftername}{}}%
      \title@titleformat{#2}%
      \title@aftertitle}\par 
  \endgroup
  \nobreak 
  \title@setheadingskip{after}%
  \title@iffixskip{\title@fixheadingskip}{}%
  \vskip\title@headingskip
  \title@classhook@topend}
\protected\def\@makestophead #1#2{%
  \title@setheadingskip{before}%
  \title@iffixskip{\title@fixtopskip}{}%
  \vspace*{\title@headingskip}%
  \begingroup
    \title@heading@format@initial 
    \title@format{%
      \title@headinghang{}%
      \title@titleformat{#2}%
      \title@aftertitle}\par 
  \endgroup
  \nobreak 
  \title@setheadingskip{after}%
  \title@iffixskip{\title@fixheadingskip}{}%
  \vskip\title@headingskip
  \title@classhook@topend}
% 例如：\section 
\def\title@classkeys@normal{}
\def\title@classinitial@normal{}
\def\title@classhook@normalbegin{}
\def\title@classhook@normalend{\title@floatbarrier@hook}
\def\title@classhook@normalafterdef{}
\let\title@floatbarrier@hook\@empty 
\protected\def\title@class@normal #1#2{%
  \title@iffloatbarrier
    {\FloatBarrier
      \gdef\title@floatbarrier@hook{\@fb@topbarrier 
        \gdef\title@floatbarrier@hook{}}}
    {}%
  \if@noskipsec \leavevmode \fi 
  \par 
  \title@ifafterindent{\@afterindenttrue}{\@afterindentfalse}%
  \if@nobreak \title@classhook@normalbegin \everypar{}%
  \else 
    \title@break
    \title@classhook@normalbegin 
    \title@setheadingskip{before}%
    \title@iffixskip{\title@fixtopskip}{}%
    \title@ifensureskip{\hrule\@height\z@\relax \par}{}%
    \addvspace{\title@headingskip}%
  \fi 
  \title@ifstar{#2}{\title@class@normal@@}{\title@class@normal@}{#1}}
\protected\def\title@class@normal@ #1#2#3{%
  \ifnum\title@getlevel>\c@secnumdepth
    \title@ifnamefalse
    \title@makeanchor{#1}%
    \let\@svsec\@empty 
  \else 
    \title@ifnumbering
      {\title@ifnametrue \refstepcounter{#1}%
        \protected@edef\@svsec{\title@name\title@aftername}\relax}
      {\title@ifnamefalse \title@makeanchor{#1}%
        \let\@svsec\@empty}%
  \fi 
  \title@beforerecord
  \title@gettitle{#2}%
  \title@recordproperties
  \title@ifrunin
    {\def\@svsechd{%
      \normalfont\title@format{%
        {\title@indentbox{\title@getindent}}\@svsec 
        \title@titleformat{#3}%
        \title@aftertitle}%
      \title@mark{#2}%
      \title@addtocline{#2}}}
    {\begingroup
      \title@heading@format@initial
      \title@format{%
        \title@headinghang{\@svsec}%
        \title@titleformat{#3}%
        \title@aftertitle}\par 
      \endgroup
      \title@mark{#2}%
      \title@addtocline{#2}}%
  \title@class@endnormal{#1}}
\protected\def\title@class@normal@@ #1#2#3{%
  \title@makeanchor{#1}%
  \title@ifnamefalse 
  \title@beforerecord
  \title@gettitle{#2}%
  \title@recordproperties
  \title@ifrunin
    {\def\@svsechd{%
      \normalfont\title@format{%
        {\title@indentbox{\title@getindent}}%
        \title@titleformat{#3}%
        \title@aftertitle}}}
    {\begingroup
      \title@heading@format@initial 
      \title@format{%
        \title@headinghang{}%
        \title@titleformat{#3}%
        \title@aftertitle}\par 
      \endgroup}%
  \title@class@endnormal{#1}}
\protected\def\title@class@endnormal #1{%
  \title@ifrunin
    {\@nobreakfalse 
      \global\@noskipsectrue
      \everypar{%
        \if@noskipsec 
          \global\@noskipsecfalse 
          {\setbox\z@\lastbox}%
          \clubpenalty\@M 
          \begingroup \@svsechd \endgroup
          \unskip 
          \begingroup \title@setheadingskip{after}%
            \unless\ifdim\title@headingskip=\z@ \hskip\title@headingskip \fi 
          \endgroup 
        \else \clubpenalty\@clubpenalty \everypar{}\fi}}
    {\par\nobreak 
      \title@setheadingskip{after}%
      \title@iffixskip{\title@fixheadingskip}{}%
      \vskip\title@headingskip 
      \@afterheading}%
  \title@classhook@normalend 
  \ignorespaces}
\def\title@classkeys@free{}
\def\title@classinitial@free{}
\def\title@classhook@freebegin{}
\def\title@classhook@freeend{}
\def\title@classhook@freeafterdef{}
\protected\def\title@class@free #1#2{%
  \title@iffloatbarrier
    {\FloatBarrier
      \gdef\title@floatbarrier@hook{\@fb@topbarrier 
        \gdef\title@floatbarrier@hook{}}}
    {}%
  \if@noskipsec \leavevmode \fi
  \par 
  \title@ifafterindent{\@afterindenttrue}{\@afterindentfalse}%
  \if@nobreak \title@classhook@freebegin \everypar{}%
  \else 
    \title@break
    \title@classhook@freebegin 
    \title@setheadingskip{before}%
    \title@iffixskip{\title@fixtopskip}{}%
    \title@ifensureskip{\hrule\@height\z@\relax \par}{}%
    \addvspace{\title@headingskip}%
  \fi 
  \title@ifstar{#2}{\title@class@free@@}{\title@class@free@}{#1}}
\protected\def\title@class@free@ #1#2#3{%
  \ifnum\title@getlevel>\c@secnumdepth 
    \title@ifnamefalse 
    \title@makeanchor{#1}%
    \let\@svsec\@empty 
  \else 
    \title@ifnumbering
      {\title@ifnametrue \refstepcounter{#1}%
        \protected@edef\@svsec{\title@name\title@aftername}\relax}
      {\title@ifnamefalse \title@makeanchor{#1}%
        \let\@svsec\@empty}%
  \fi
  \title@beforerecord
  \title@gettitle{#1}%
  \title@recordproperties
  \title@mark{#2}%
  \title@addtocline{#2}%
  \title@heading@format@initial 
  {\title@format{%
    \@svsec
    \title@titleformat{#3}%
    \title@aftertitle}}%
  \title@class@endfree{#1}}
\protected\def\title@class@free@@ #1#2#3{%
  \title@ifnamefalse 
  \title@makeanchor{#1}%
  \title@beforerecord
  \title@gettitle{#2}%
  \title@recordproperties
  \title@heading@format@initial 
  {\title@format{%
    \@svsec
    \title@titleformat{#3}%
    \title@aftertitle}}%
  \title@class@endfree{#1}}
\protected\def\title@class@endfree #1{%
  \ifvmode 
    \title@setheadingskip{after}%
    \title@iffixskip{\title@fixheadingskip}{}%
    \vskip\title@headingskip 
    \@afterheading 
  \fi 
  \title@classhook@freeend 
  \ignorespaces}
\def\title@classkeys@wrap{}
\def\title@classinitial@wrap{}
\def\title@classhook@wrapbegin{}
\def\title@classhook@wrapend{}
\def\title@classhook@wrapafterdef{}
\protected\def\title@class@wrap #1#2#3#4{%
  \title@iffloatbarrier
    {\FloatBarrier
      \gdef\title@floatbarrier@hook{\@fb@topbarrier 
        \gdef\title@floatbarrier@hook{}}}
    {}%
  \if@noskipsec \leavevmode \fi
  \par 
  \title@ifafterindent{\@afterindenttrue}{\@afterindentfalse}%
  {\title@ifmeasuringtrue 
    \title@setvarwidth\@tempboxa{.4\textwidth}{%
      \title@ifstar{#2}{%
        \title@ifnamefalse 
        \title@makeanchor{#1}%
        \let\@svsec\@empty}{%
        \ifnum\title@getlevel>\c@secnumdepth 
          \title@ifnamefalse 
          \title@makeanchor{#1}%
          \let\@svsec\@empty
        \else 
          \title@ifnumbering
            {\title@ifnametrue \refstepcounter{#1}%
              \protected@edef\@svsec{\title@name\title@aftername}\relax}
            {\title@ifnamefalse \title@makeanchor{#1}%
              \let\@svsec\@empty}%
        \fi 
      }%
      \title@beforerecord
      \title@gettitle{#2}%
      \title@recordproperties%
      \title@heading@format@initial 
      \title@format{%
        \@svsec
        \title@titleformat{#4}%
        \title@aftertitle}\par\@@par
      \title@setheadingskip{after}%
      \title@iffixskip{\title@fixheadingskip}{}%
      \vskip\title@headingskip}%
    \global\setbox\@ne\vtop{\unvbox\@tempboxa}}
  \@tempdima\ht\@ne \advance\@tempdima\dp\@ne 
  \@tempdimb\@tempdima \advance\@tempdimb\baselineskip
  \divide\@tempdima\baselineskip \count@\@tempdima 
  \advance\count@
    \ifdim\@tempdimb<\the\count@.5\baselineskip\@ne\else\tw@\fi
  \setbox\title@box\hbox{%
    \title@setheadingskip{left}\hskip\title@headingskip
    \raise\fpeval{.825*\f@size}\p@ \hbox{\box\@ne}%
    \title@setheadingskip{right}\hskip\title@headingskip}%
  \dp\title@box\z@ 
  \needspace{\@tempdimb}%
  \title@ifmeasuringfalse
  \if@nobreak \title@classhook@wrapbegin \everypar{}%
  \else 
    \title@break
    \title@classhook@wrapbegin 
    \title@setheadingskip{before}%
    \title@iffixskip{\title@fixtopskip}{}%
    \title@ifensureskip{\hrule\@height\z@\relax \par}{}%
    \addvspace{\title@headingskip}%
  \fi 
  \title@mark{#3}%
  \title@addtocline{#3}%
  \hangindent\wd\title@box \hangafter-\count@ 
  \noindent\llap{\box\title@box}%
  \let\whu@tmp\ignorespaces
  \def\ignorespaces{\let\ignorespaces\whu@tmp\whu@ignorepars}} % 这里暂时使用 \ignorepars，另见 titlesec 的 \ttlhx@wrap


\definetitle\part[page]{
  name={第,部分},
  number=\Roman{part},
  format=\huge\bfseries\centering,
  aftername=\par\vskip 20pt,
  aftertitle=\par,
  beforeskip=0pt plus 1fil,
  afterskip=0pt plus 1fil,
  break=\if@openright\cleardoublepage\else\clearpage\fi,
  tocline=\titleifname{\titlethepart\hspace{1em}}{}#2,
}
\definetitle\chapter[top]{
  name={第,章},
  number=\chinese{chapter},
  format=\huge\bfseries\centering,
  aftername=\quad,
  aftertitle=\par,
  beforeskip=50pt,
  afterskip=40pt,
  break=\if@openright\cleardoublepage\else\clearpage\fi,
  afterindent=true,
  tocline=\titleifname{\protect\numberline{\titlethechapter\hspace{.3em}}}{}#2,
  mark=\chaptermark,
}
\newcommand\titlenumberline[1]%
  {\titleifname{\protect\numberline{\@nameuse{titlethe#1}}}{}}
\definetitle\section{
  level=section,
  number=\arabic{section},
  format=\Large\bfseries\centering,
  aftername=\quad,
  aftertitle=\@@par,
  hang=true,
  beforeskip=3.5ex plus 1ex minus .2ex,
  afterskip=2.3ex plus .2ex,
  break=\addpenalty{\@secpenalty},
  afterindent=true,
  tocline=\titlenumberline{#1}#2,
  mark=\sectionmark,
}
\definetitle\subsection{
  level=subsection,
  number=\thesection.\arabic{subsection},
  format=\large\bfseries,
  aftername=\quad,
  aftertitle=\@@par,
  hang=true,
  beforeskip=3.25ex plus 1ex minus .2ex,
  afterskip=1.5ex plus .2ex,
  break=\addpenalty{\@secpenalty},
  afterindent=true,
  tocline=\titlenumberline{#1}#2,
}
\definetitle\subsubsection{
  level=subsubsection,
  number=\thesubsection.\arabic{subsubsection},
  format=\normalsize\bfseries,
  aftername=\quad,
  aftertitle=\@@par,
  hang=true,
  beforeskip=3.25ex plus 1ex minus .2ex,
  afterskip=1.5ex plus .2ex,
  break=\addpenalty{\@secpenalty},
  afterindent=true,
  tocline=\titlenumberline{#1}#2,
}
\definetitle\paragraph{
  level=paragraph,
  number=\thesubsubsection.\arabic{paragraph},
  format=\normalsize\bfseries,
  aftername=\quad,
  runin=true,
  beforeskip=3.25ex plus 1ex minus .2ex,
  afterskip=1em,
  break=\addpenalty{\@secpenalty},
  afterindent=true,
  tocline=\titlenumberline{#1}#2,
}
\definetitle\subparagraph{
  level=subparagraph,
  number=\theparagraph.\arabic{subparagraph},
  format=\normalsize\bfseries,
  aftername=\quad,
  runin=true,
  indent=\parindent,
  beforeskip=3.25ex plus 1ex minus .2ex,
  afterskip=1em,
  break=\addpenalty{\@secpenalty},
  afterindent=true,
  tocline=\titlenumberline{#1}#2,
}

\ExplSyntaxOn

\DeclareDocumentCommand \frontmatter { O{} } 
  {
    \cleardoublepage
    \@mainmatterfalse 
    \pagenumbering{roman}
  }
\DeclareDocumentCommand \mainmatter { O{} } 
  {
    \cleardoublepage
    \@mainmattertrue 
    \pagenumbering{arabic}
  }
\DeclareDocumentCommand \backmatter { O{} } 
  {
    \if@openright
      \cleardoublepage
    \else
      \clearpage
    \fi
    \@mainmatterfalse
  }