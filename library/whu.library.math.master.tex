\WHUDependency 
  {
    package = { amsmath },
    library = { util, math.theorem, cover, constant, declaration, authorization, bib }
  }
\WHUProvideExplLibrary{math-master}{\whu@date}{\whu@version}{Compatible with the configuration of Huang Zhenhua's template for master}


% 硕士学位类型：academic, professional
\keys_define:nn { whu/master }
  {
    degree-type .str_gset:N = \g__whu_master_degree_type_str,
    degree-type .initial:n = academic,
  }

\ProcessKeyOptions [ whu/master ]



% ------------ %
% constant 设置 %
% ------------ %
\AtEndPreamble
  {
    \str_case:VnF \g__whu_master_degree_type_str
      {
        { academic } { \__whu_academic_master_constant_set: }
        { professional } { \__whu_professional_master_constant_set: }
      }
      {
        \msg_error:nnx { whu } { invalid-degree-type } 
          { \str_use:N \g__whu_master_degree_type_str }
      }
  }
\msg_new:nnn { whu } { invalid-degree-type }
  {
    Invalid~degree~type~`#1'. \\ Please~use~`academic'~or~`professional'. 
  }
\cs_new:Nn \__whu_academic_master_constant_set:
  {
    \__whu_set_information_family:n
      {
        thesis-type/zh = \ziju{1} 硕士学位论文,
        title =
          {
            zh = 武汉大学硕士学位论文 \LaTeX{} 模板,
            en = \LaTeX{} Template~for~Professional~Master's~Degree~of~Wuhan~University
          },
        department =
          {
            zh = 数学与统计学院,
            en = School~of~Mathematics~and~Statistics
          },
        author =
          {
            zh = 研究生姓名,
            en = Candidate
          },
        student-id =
          {
            zh = 学号,
            en = Student~Number
          },
        supervisor =
          {
            zh = 指导教师姓名、职称,
            en = Supervisor
          },
        major =
          {
            zh = 专业名称,
            en = Major
          },
        professional-field =
          {
            zh = 研究方向,
            en = Speciality
          },
      }
    \__whu_set_information_constant_family:n
      {
        clc/zh          = 分类号,
        secret-level/zh = 密级,
        udc/zh          = UDC,
        school-id/zh    = 编号,
        author =
          {
            zh = 研究生姓名,
            en = Candidate
          },
        student-id =
          {
            zh = 学号,
            en = Student~Number
          },
        supervisor =
          {
            zh = 指导教师姓名、职称,
            en = Supervisor
          },
        major =
          {
            zh = 专业名称,
            en = Major
          },
        professional-field =
          {
            zh = 研究方向,
            en = Speciality
          },
      }
    \cs_set:Nn \__whu_cover_zh_information_content: 
      {
        \begin{minipage} [ c ] { 0.72\textwidth }
          \clist_set:Nx \l__whu_tmpa_clist
            {
              \__whu_use_information_constant:nn { author } { zh } ,
              \__whu_use_information_constant:nn { student-id } { zh } ,
              \__whu_use_information_constant:nn { supervisor } { zh } ,
              \__whu_use_information_constant:nn { major } { zh } ,
              \__whu_use_information_constant:nn { professional-field } { zh }
            }
          \clist_set:Nx \l__whu_tmpb_clist
            {
              \__whu_use_information:nn { author } { zh },
              \__whu_use_information:nn { student-id } { zh },
              \__whu_use_information:nn { supervisor } { zh },
              \__whu_use_information:nn { major } { zh },
              \__whu_use_information:nn { professional-field } { zh }
            }
          \bool_until_do:nn
            { \clist_if_empty_p:N \l__whu_tmpa_clist }
            {
              \clist_pop:NN \l__whu_tmpa_clist \l__whu_tmpa_tl
              \clist_pop:NN \l__whu_tmpb_clist \l__whu_tmpb_tl
              \__whu_spread_box:nn { 4.45cm } { \l__whu_tmpa_tl } :
              \hspace{1.3em}
              \l__whu_tmpb_tl
              \skip_vertical:n { 3ex }
            }
        \end{minipage}
      }
    \cs_set:Nn \__whu_cover_en_information_content: 
      {
        \begin{tblr}
          {
            cell{1, 3}{2} = { cmd = \textsc },
            % hlines, vlines,
            colspec = { X[1,r] X[1,l] },
            rowsep = 1.5pt
          }
          \__whu_use_information_constant:nn { author } { en } : & \__whu_use_information:nn { author } { en } \\
          \__whu_use_information_constant:nn { student-id } { en } : & \__whu_use_information:nn { student-id } { en } \\
          \__whu_use_information_constant:nn { supervisor } { en } : & \__whu_use_information:nn { supervisor } { en } \\
          \__whu_use_information_constant:nn { major } { en } : & \__whu_use_information:nn { major } { en } \\
          \__whu_use_information_constant:nn { professional-field } { en } : & \__whu_use_information:nn { professional-field } { en }
        \end{tblr}
      }
  }
\cs_new:Nn \__whu_professional_master_constant_set:
  {
    \__whu_set_information_family:n
      {
        thesis-type/zh = \ziju{0.5} 硕士专业学位论文,
        title =
          {
            zh = 武汉大学硕士专业学位论文 \LaTeX{} 模板,
            en = \LaTeX{} Template~for~Professional~Master's~Degree~of~Wuhan~University
          },
        department =
          {
            zh = 数学与统计学院,
            en = School~of~Mathematics~and~Statistics
          },
        author =
          {
            zh = 研究生姓名,
            en = Candidate
          },
        student-id =
          {
            zh = 学号,
            en = Student~Number
          },
        supervisor =
          {
            zh = 指导教师姓名、职称,
            en = Supervisor
          },
        major =
          {
            zh = 专业名称,
            en = Major
          },
      }
    \__whu_set_information_constant_family:n
      {
        clc/zh          = 分类号,
        secret-level/zh = 密级,
        udc/zh          = UDC,
        school-id/zh    = 编号,
        author =
          {
            zh = 研究生姓名,
            en = Candidate
          },
        student-id =
          {
            zh = 学号,
            en = Student~Number
          },
        supervisor =
          {
            zh = 指导教师姓名、职称,
            en = Supervisor
          },
        major =
          {
            zh = 专业类别（领域）,
            en = Major
          },
      }
    \cs_set:Nn \__whu_cover_zh_information_content: 
      {
        \begin{minipage} [ c ] { 0.72\textwidth }
          \clist_set:Nx \l__whu_tmpa_clist
            {
              \__whu_use_information_constant:nn { author } { zh } ,
              \__whu_use_information_constant:nn { student-id } { zh } ,
              \__whu_use_information_constant:nn { supervisor } { zh } ,
              \__whu_use_information_constant:nn { major } { zh } ,
            }
          \clist_set:Nx \l__whu_tmpb_clist
            {
              \__whu_use_information:nn { author } { zh },
              \__whu_use_information:nn { student-id } { zh },
              \__whu_use_information:nn { supervisor } { zh },
              \__whu_use_information:nn { major } { zh },
            }
          \bool_until_do:nn
            { \clist_if_empty_p:N \l__whu_tmpa_clist }
            {
              \clist_pop:NN \l__whu_tmpa_clist \l__whu_tmpa_tl
              \clist_pop:NN \l__whu_tmpb_clist \l__whu_tmpb_tl
              \__whu_spread_box:nn { 4.45cm } { \l__whu_tmpa_tl } :
              \hspace{1.3em}
              \l__whu_tmpb_tl
              \skip_vertical:n { 3ex }
            }
        \end{minipage}
      }
    \cs_set:Nn \__whu_cover_en_information_content: 
      {
        \begin{tblr}
          {
            cell{1, 3}{2} = { cmd = \textsc },
            % hlines, vlines,
            colspec = { X[1,r] X[1,l] },
            rowsep = 1.5pt
          }
          \__whu_use_information_constant:nn { author } { en } : & \__whu_use_information:nn { author } { en } \\
          \__whu_use_information_constant:nn { student-id } { en } : & \__whu_use_information:nn { student-id } { en } \\
          \__whu_use_information_constant:nn { supervisor } { en } : & \__whu_use_information:nn { supervisor } { en } \\
          \__whu_use_information_constant:nn { major } { en } : & \__whu_use_information:nn { major } { en } \\
        \end{tblr}
      }
  }


% -------- %
% 超链接设置 %
% -------- %
\AtEndPreamble
  {
    \RequirePackage { hyperref }
    \hypersetup 
      { 
        pdfencoding = auto,
        citecolor   = magenta,
        linkcolor   = blue,
        hidelinks
      }
  }



% ----------------- %
% 不同文档类型下的设置 %
% ----------------- %

% \cs_set:Npn \__whu_set_type_electronic:
%   {
    
%   }
% \cs_set:Npn \__whu_set_type_for_print:
%   {
    
%     \AtEndPreamble { \hypersetup { allcolors = black } }
%   }
% \cs_set:Npn \__whu_set_type_for_library:
%   {
    
%     \AtEndPreamble { \hypersetup { allcolors = black } }
%   }



% ---------- %
% 页面布局设置 %
% ---------- %
\cs_new:Npn \__whu_set_layout:
  {
    \setuplayout
      {
        papername = a4paper,
        top       = 3truecm,
        footskip  = 0.87cm,  % 如果直接是 geometry 接口则不需要设置 footskip，可能是因为黄 load 的是 ctexbook，而本模板 load 的是 book，ctexbook 可能做了一些处理
        bottom    = 2.9truecm,
        left      = 2.8truecm,
        right     = 2.5truecm,
        % includefoot,
        % includehead,
        % showframe,
        % xetex
      }
  }
\whu@ifmoduleloaded { layout }
  { \__whu_set_layout: }
  { \whu_after_class:n { \__whu_set_layout: } }



% ------- %
% 页眉页脚 %
% ------- %
\cs_new:Npn \__whu_set_headfoot:
  {
    \str_case:Vn \g__whu_master_degree_type_str
      {
        { academic } { \__whu_academic_set_headfoot: }
        { professional } { \__whu_professional_set_headfoot: }
      }
  }
\cs_new:Nn \__whu_academic_set_headfoot:
  {
    \setpagestyle { frontmatter }
      {
        \setheadrulewidth { 0.5pt }
        \setfootrulewidth { 0pt }
        \setcenterhead
          [ 武汉大学硕士学位论文 ]
          { 标题 } % TODO
        \sethead [LR] {}
        \setcenterfoot 
          { 
            -\,
            \int_to_Roman:n { \c@page }  % 此处不能用 \thepage, 因为在 \frontmatter 和 \mainmatter 之间是小写罗马数字格式
            \,- 
          }
      }
    \setpagestyle { mainmatter } [ frontmatter ]
      {
        \setcenterfoot { -\, \int_to_arabic:n { \c@page } \,- }
      }
    \AddToHook { cmd/frontmatter/after }
      {
        \usepagestyle { frontmatter } 
        \setuptitle [ chapter ] { pagestyle = frontmatter }
      }
    \AddToHook { cmd/mainmatter/after }
      {
        \usepagestyle { mainmatter } 
        \setuptitle [ chapter ] { pagestyle = mainmatter }
      }
  }
\cs_new:Nn \__whu_professional_set_headfoot:
  {
    \setpagestyle { frontmatter }
      {
        \setheadrulewidth { 0.5pt }
        \setfootrulewidth { 0pt }
        \setcenterhead
          [ 武汉大学硕士专业学位论文 ]
          { 标题 } % TODO
        \sethead [LR] {}
        \setcenterfoot 
          { 
            -\,
            \int_to_Roman:n { \c@page }  % 此处不能用 \thepage, 因为在 \frontmatter 和 \mainmatter 之间是小写罗马数字格式
            \,- 
          }
      }
    \setpagestyle { mainmatter } [ frontmatter ]
      {
        \setcenterfoot { -\, \int_to_arabic:n { \c@page } \,- }
      }
    \AddToHook { cmd/frontmatter/after }
      {
        \usepagestyle { frontmatter } 
        \setuptitle [ chapter ] { pagestyle = frontmatter }
      }
    \AddToHook { cmd/mainmatter/after }
      {
        \usepagestyle { mainmatter } 
        \setuptitle [ chapter ] { pagestyle = mainmatter }
      }
  }
\AtEndPreamble { \__whu_set_headfoot: }



% ---------- %
% 章节标题设置 %
% ---------- %
\cs_new:Npn \__whu_set_title:
  {
    \setsecnumdepth { 4 }
    \setuptitle [ chapter, section, subsection, subsubsection ]
      {
        format = \bfseries\heiti\raggedright
      }
    \setuponetitle { chapter }
      {
        name       = {,},
        number     = { \arabic { chapter } },
        format+    = { \zihao{-2} },
        afterskip  = 30pt,
        beforeskip = 20pt
      }
    \setuponetitle { section }
      {
        format+  = { \zihao{3} },
        number = { \arabic { chapter }.\arabic { section } },
      }
    \setuponetitle { subsection }
      {
        format+  = { \zihao{4} },
        number = { \arabic { chapter }.\arabic { section }. \arabic { subsection } },
      }
    \setuponetitle { subsubsection }
      {
        format+ = { \zihao{-4}\kaishu },
        number  = { \arabic { chapter }.\arabic { section }. \arabic { subsection }. \arabic { subsubsection } },
      }
    \AddToHook { cmd/frontmatter/after }
      {
        \setuponetitle { chapter } { mode = nonumber }
      }
    \AddToHook { cmd/tableofcontents/before }
      {
        \setuponetitle { chapter }  { mode = starred }
      }
    \AddToHook { cmd/mainmatter/after }
      {
        \setuponetitle { chapter }  { mode = normal }
      }
  }
\whu_after_class:n { \__whu_set_title: }




% ------- %
% 目录设置 %
% ------- %
\cs_new:Npn \__whu_math_set_toc:
  {
    % 目录标题
    \AddToHook { cmd/tableofcontents/before }
      { \renewcommand { \contentsname } { 目\qquad 录 } }
    % 目录层级
    \setplaintocdepth { 4 }
    % 目录的页码样式
    \AddToHook { cmd/frontmatter/after }
      { \pagenumbering { Roman } }
    \AddToHook { cmd/mainmatter/after }
      { \pagenumbering { arabic } }
  }
\whu@ifmoduleloaded { struct }
  { \__whu_math_set_toc: }
  { \whu_after_class:n { \__whu_math_set_toc: } }



% ---------- %
% 图表样式设置 %
% ---------- %
\whu_after_class:n
  {
    \RequirePackage { caption }
    \captionsetup
      {
        font     = small,
        textfont = it
      }
  }



% ------- %
% 数学设置 %
% ------- %
\allowdisplaybreaks



% ------- %
% 行距设置 %
% ------- %
\AddToHook { cmd/frontmatter/after }
  { \linespread{1.6} \selectfont }



% ------- %
% 封面设置 %
% ------- %
\cs_new:Nn \__whu_cover_output:
  {
    \str_case:Vn \g__whu_master_degree_type_str
      {
        { academic } { \__whu_academic_master_cover: }
        { professional } { \__whu_professional_master_cover: }
      }
  }
\cs_new:Nn \__whu_academic_master_cover: 
  {
    \__whu_academic_master_cover_zh:
    \__whu_if_cleardoublepage:
    \__whu_academic_master_cover_en:
    \__whu_if_cleardoublepage:
  }
\cs_new:Nn \__whu_professional_master_cover: 
  {
    \__whu_professional_master_cover_zh:
    \__whu_if_cleardoublepage:
    \__whu_professional_master_cover_en:
    \__whu_if_cleardoublepage:
  }
\cs_new:Nn \__whu_academic_master_cover_zh: 
  {
    \__whu_academic_master_cover_zh_set:
    \__whu_cover_zh:
  }
\cs_new:Nn \__whu_academic_master_cover_en: 
  {
    \__whu_academic_master_cover_en_set:
    \__whu_cover_en:
  }
\cs_new:Nn \__whu_academic_master_cover_zh_set: { }
\cs_new:Nn \__whu_academic_master_cover_en_set: { }
\cs_new:Nn \__whu_professional_master_cover_zh: 
  {
    \__whu_professional_master_cover_zh_set:
    \__whu_cover_zh:
  }
\cs_new:Nn \__whu_professional_master_cover_en: 
  {
    \__whu_professional_master_cover_en_set:
    \__whu_cover_en:
  }
\cs_new:Nn \__whu_professional_master_cover_zh_set: { }
\cs_new:Nn \__whu_professional_master_cover_en_set: { }


% ----------- %
% 论文原创性声明 %
% ----------- %
% 用 \AtBeginDocument 会报错
\ctex_after_end_preamble:n
  {
    \usepagestyle { totalempty }
    \__whu_cover_output:
    \__whu_declaration_output: 
  }


% ------- %
% 摘要设置 %
% ------- %
\WHULoadLibrary { abstract }
\__whu_set_title_constant_family:n
  {
    abstract =
      {
        zh     = 摘 \qquad 要,
        zh-toc = 摘要,
        en     = ABSTRACT,
      },
    keywords =
      {
        zh = 关键词 ,
        en = Key~words
      }
  }
\cs_set:Nn \__whu_abstract_zh_format: 
  { \songti \zihao { -4 } }
\cs_set:Nn \__whu_abstract_en_format: 
  { \songti \zihao { -4 } }
\cs_set:Nn \__whu_keywords_constant_zh_format_set:
  { \heiti \zihao { -4 } }
\cs_set:Nn \__whu_keywords_constant_en_format_set:
  { \bfseries \zihao { -4 } }
\cs_set:Nn \__whu_keywords_zh_above_sep: 
  { \par \vfill }
\cs_set:Nn \__whu_keywords_en_above_sep:
  { \par \vfill }




% ---------- %
% 参考文献设置 %
% ---------- %
\cs_set:Nn \__whu_bib_printbibliography_preset: 
  { \setupnexttitle { format+ = \large } }




% ------ %
% 学术成果 %
% ------ %
\WHULoadLibrary { publications }
\cs_set:Npn \__whu_publications_format_set:
  {
    \setupnexttitle { mode = nonumber }  % \setuponetitle 改成 \setupnexttitle （注意不能是 \setupnexttitle+，这里利用的是“不带符号的 \setupnexttitle 只取最近的那个产生作用”）可以避免参考文献未编译出来时，参考文献的 \setupnexttitle 设置影响到后面的章节标题
    \__whu_set_title_constant_family:n
      {
        publications =
          {
            zh = 攻硕期间发表的科研成果目录
          }
      }
  }
% publications 的设置来自 thuthesis
\whu_after_class:n
  {
    \IfPackageLoadedTF { enumitem }
      {
        \newlist { achievements } { enumerate } { 1 }
        \setlist [ achievements ]
          {
            topsep     = 6bp,
            partopsep  = 0bp,
            itemsep    = 6bp,
            parsep     = 0bp,
            leftmargin = 10mm,
            itemindent = 0pt,
            align      = left,
            label      = [\arabic*],
            resume     = achievements,
          }
      }
      { 
        \RequirePackage { enumitem } 
        \newlist { achievements } { enumerate } { 1 }
        \setlist [ achievements ]
          {
            topsep     = 6bp,
            partopsep  = 0bp,
            itemsep    = 6bp,
            parsep     = 0bp,
            leftmargin = 10mm,
            itemindent = 0pt,
            align      = left,
            label      = [\arabic*],
            resume     = achievements,
          }
      }
  }

\cs_set:Npn \__whu_publications_begin:
  {
    \begin{achievements}
  }
\cs_set:Npn \__whu_publications_end:
  {
    \end{achievements}
  }



% --- %
% 致谢 %
% --- %
\WHULoadLibrary { acknowledgement }
\cs_set:Npn \__whu_acknowledgement_format_set:
  {
    \setuponetitle { chapter } 
      {
        mode    = nonumber,
        % format+ = \ziju{2},  % 是否添加似乎并不影响效果（可能因为只有两个字）
      }
    \__whu_set_title_constant_family:n
      {
        acknowledgement =
          {
            zh-toc = 致谢 ,
            zh     = 致\qquad 谢
          }
      }
  }



% ------------------------- %
% 武汉大学学位论文使用授权协议书 %
% ------------------------- %
\AtEndDocument { \__whu_authorization_output: }
% 如果把 % \cs_set_eq:NN \clearpage \relax
% \cs_set_eq:NN \cleardoublepage \relax
% 就失效了
% \AddToHook{env/document/end}{ \__whu_authorization_output: }